<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Enfermeiro Inteligente - Controle de Medicamentos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; 
        }
        
        .dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        
        .btn-principal, .btn-secundario, .btn-icon { 
            transition: all 0.2s ease-in-out; 
        }
        
        .btn-principal:active, .btn-secundario:active, .btn-icon:active { 
            transform: scale(0.95); 
            filter: brightness(0.9); 
        }
        
        .fade-in-scale { 
            animation: fadeInScale 0.4s ease-out forwards; 
        }
        
        @keyframes fadeInScale { 
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        }
        
        .card-concluido { 
            background-color: #e8f5e9; 
            border-left-color: #4caf50; 
            opacity: 0.8; 
        }
        
        .card-concluido .info-remedio { 
            text-decoration: line-through; 
            color: #555; 
        }
        
        .card-atrasado {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        
        .card-proximo {
            border-left-color: #ff9800;
            background-color: #fff3e0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success { background-color: #4caf50; color: white; }
        .toast-error { background-color: #f44336; color: white; }
        .toast-info { background-color: #2196f3; color: white; }
        
        .input-error {
            border-color: #f44336 !important;
            background-color: #ffebee !important;
        }
        
        .error-message {
            color: #f44336;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        @media print {
            body * { visibility: hidden; }
            #relatorio-imprimir, #relatorio-imprimir * { visibility: visible; }
            #relatorio-imprimir { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
        
        .dark-mode .bg-white {
            background-color: #2d3748 !important;
            color: #e2e8f0;
        }
        
        .dark-mode .text-gray-900 {
            color: #e2e8f0 !important;
        }
        
        .dark-mode .text-gray-600 {
            color: #cbd5e0 !important;
        }
        
        .dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-gray-900">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6">

        <header class="text-center mb-8 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-4xl">馃拪</span>
                    <h1 class="text-3xl sm:text-4xl font-bold text-blue-800">Meu Enfermeiro Inteligente</h1>
                </div>
                <div class="flex gap-2">
                    <button id="btn-toggle-dark" class="btn-icon p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition" title="Alternar modo escuro">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                    <button id="btn-notifications" class="btn-icon p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition relative" title="Configurar notifica莽玫es">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </button>
                </div>
            </div>
            <p class="text-gray-600 text-lg mt-1">Hoje 茅 <span id="current-date" class="font-semibold"></span></p>
            <p class="text-gray-500 text-sm mt-2">Seu assistente pessoal para nunca esquecer seus medicamentos</p>
        </header>

        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-10">
            <button id="btn-open-modal" class="btn-principal bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg text-xl flex items-center gap-3 w-full sm:w-auto hover:bg-blue-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                Adicionar Tratamento
            </button>
            <button id="btn-open-relatorio" class="btn-secundario bg-white text-blue-600 border-2 border-blue-500 font-bold py-3 px-6 rounded-full shadow-sm text-lg flex items-center gap-3 w-full sm:w-auto hover:bg-blue-50 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                Ver Relat贸rio
            </button>
        </div>

        <main id="checklist-container" class="space-y-10"></main>
        
        <div id="placeholder" class="text-center bg-white/90 backdrop-blur-sm p-10 rounded-2xl shadow-xl mt-10">
            <div class="text-6xl mb-4">馃拪</div>
            <p class="mt-4 text-xl text-gray-600 font-semibold">Nenhum tratamento ativo para hoje.</p>
            <p class="text-gray-500 mt-2">Clique no bot茫o "Adicionar Tratamento" acima para come莽ar!</p>
            <p class="text-gray-400 mt-4 text-sm">Seu enfermeiro inteligente est谩 pronto para ajud谩-lo a gerenciar seus medicamentos.</p>
        </div>
        
        <footer class="mt-12 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold mb-3 text-center">Progresso do Dia</h3>
            <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-green-600 h-6 rounded-full transition-all duration-500 flex items-center justify-center text-white font-bold text-sm" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-lg text-gray-600 mt-3 text-center"></p>
            <div id="next-dose-info" class="mt-4 p-4 bg-blue-50 rounded-lg text-center hidden">
                <p class="text-sm text-gray-600">Pr贸xima dose:</p>
                <p class="text-lg font-bold text-blue-700" id="next-dose-text"></p>
            </div>
        </footer>

        <div class="mt-8 text-center text-white/80 text-sm">
            <p>Desenvolvido com IA por thIAguinho Solu莽玫es</p>
        </div>

    </div>

    <!-- Modal para Adicionar/Editar Tratamento -->
    <div id="med-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all max-h-[90vh] overflow-y-auto" id="modal-content">
            <form id="form-remedio" class="p-6 sm:p-8 space-y-5">
                <input type="hidden" id="tratamento-id">
                
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-2xl font-bold">Novo Tratamento</h2>
                    <button type="button" id="btn-close-modal-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                
                <div>
                    <label for="nome-remedio" class="block text-lg font-medium mb-1">Nome do Rem茅dio *</label>
                    <input type="text" id="nome-remedio" placeholder="Ex: Azitromicina" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <p class="error-message hidden" id="error-nome-remedio"></p>
                </div>
                
                <div>
                    <label for="dosagem-remedio" class="block text-lg font-medium mb-1">Dose *</label>
                    <input type="text" id="dosagem-remedio" placeholder="Ex: 1 comprimido de 500mg" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    <p class="error-message hidden" id="error-dosagem-remedio"></p>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="tipo-tratamento" class="block text-lg font-medium mb-1">Tipo de Tratamento *</label>
                        <select id="tipo-tratamento" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                            <option value="temporario">Tempor谩rio (por X dias)</option>
                            <option value="continuo">Cont铆nuo (sem data fim)</option>
                        </select>
                    </div>
                    
                    <div id="duracao-container">
                        <label for="duracao-tratamento" class="block text-lg font-medium mb-1">Dura莽茫o (dias) *</label>
                        <input type="number" id="duracao-tratamento" placeholder="Ex: 5" min="1" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <p class="error-message hidden" id="error-duracao-tratamento"></p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-lg font-medium mb-2">Hor谩rios *</label>
                    
                    <div class="mb-3 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-700 mb-2 font-medium">Sugest玫es r谩pidas:</p>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="24">1x ao dia</button>
                            <button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="12">A cada 12h</button>
                            <button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="8">A cada 8h</button>
                            <button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="6">A cada 6h</button>
                            <button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="4">A cada 4h</button>
                        </div>
                    </div>
                    
                    <div id="horarios-container" class="space-y-2"></div>
                    <button type="button" id="btn-add-horario" class="mt-2 w-full text-blue-600 font-semibold border-2 border-dashed border-blue-400 rounded-lg py-2 hover:bg-blue-50 transition">+ Adicionar hor谩rio manualmente</button>
                    <p class="error-message hidden" id="error-horarios"></p>
                </div>
                
                <div>
                    <label for="instrucoes-remedio" class="block text-lg font-medium mb-1">Como tomar? *</label>
                    <select id="instrucoes-remedio" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="Depois de comer">Depois de comer 馃嵆</option>
                        <option value="Antes de comer (jejum)">Antes de comer (jejum) 馃晵</option>
                        <option value="Com bastante 谩gua">Com bastante 谩gua 馃挧</option>
                        <option value="Com alimentos">Com alimentos 馃嵔锔�</option>
                        <option value="Sublingual">Sublingual 馃憛</option>
                        <option value="Uso t贸pico">Uso t贸pico 馃Т</option>
                        <option value="N茫o importa">N茫o importa 馃憤</option>
                        <option value="personalizado">Personalizado 鉁忥笍</option>
                    </select>
                </div>
                
                <div id="instrucoes-personalizadas-container" class="hidden">
                    <label for="instrucoes-personalizadas" class="block text-lg font-medium mb-1">Instru莽玫es Personalizadas</label>
                    <textarea id="instrucoes-personalizadas" placeholder="Digite instru莽玫es espec铆ficas..." class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" rows="3"></textarea>
                </div>
                
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="btn-cancel-modal" class="px-8 py-3 bg-gray-200 rounded-lg text-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg text-lg hover:bg-blue-700 transition">Salvar Tratamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Relat贸rio -->
    <div id="relatorio-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all flex flex-col" style="max-height: 90vh;">
            <div id="relatorio-imprimir" class="p-6 sm:p-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold">Relat贸rio de Tratamento</h2>
                        <p class="text-gray-500 mt-1">Progresso geral at茅 <span id="relatorio-data"></span></p>
                    </div>
                    <button type="button" id="btn-close-relatorio-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none no-print">&times;</button>
                </div>
                
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-2xl font-bold text-blue-600" id="stats-total">0</p>
                            <p class="text-sm text-gray-600">Total de Tratamentos</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-600" id="stats-ativos">0</p>
                            <p class="text-sm text-gray-600">Ativos</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-purple-600" id="stats-concluidos">0</p>
                            <p class="text-sm text-gray-600">Conclu铆dos</p>
                        </div>
                    </div>
                </div>
                
                <div id="relatorio-conteudo" class="space-y-4 overflow-y-auto" style="max-height: 50vh;"></div>
            </div>
            <div class="flex justify-between gap-4 p-4 bg-gray-50 border-t rounded-b-2xl no-print">
                <button type="button" id="btn-exportar-csv" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Exportar CSV</button>
                <div class="flex gap-2">
                    <button type="button" id="btn-fechar-relatorio" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Fechar</button>
                    <button type="button" id="btn-salvar-relatorio" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Imprimir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Conclus茫o do Dia -->
    <div id="modal-conclusao" class="fixed inset-0 bg-gradient-to-br from-green-500 to-green-700 bg-opacity-95 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
         <div class="text-center text-white">
            <div class="text-9xl animate-bounce mb-6">馃帀</div>
            <h2 class="text-4xl sm:text-5xl font-bold mt-4">Parab茅ns!</h2>
            <p class="text-xl sm:text-2xl mt-4 max-w-lg">Voc锚 tomou todos os medicamentos de hoje! Continue assim! 馃憦</p>
            <div class="mt-8 p-6 bg-white/20 rounded-2xl backdrop-blur-sm">
                <p class="text-lg">Seu compromisso com a sa煤de 茅 inspirador!</p>
            </div>
            <button id="btn-reset" class="btn-principal mt-10 bg-white text-green-600 font-bold py-4 px-8 rounded-full shadow-lg text-xl hover:bg-gray-100 transition">Entendido</button>
        </div>
    </div>

    <!-- Modal de Confirma莽茫o de Exclus茫o -->
    <div id="modal-confirmar-exclusao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 sm:p-8">
            <div class="text-center">
                <div class="text-6xl mb-4">鈿狅笍</div>
                <h3 class="text-2xl font-bold mb-2">Confirmar Exclus茫o</h3>
                <p class="text-gray-600 mb-6">Tem certeza que deseja excluir este tratamento? Esta a莽茫o n茫o pode ser desfeita.</p>
                <div class="flex gap-4 justify-center">
                    <button type="button" id="btn-cancelar-exclusao" class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="button" id="btn-confirmar-exclusao" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">Sim, Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configura莽茫o de Notifica莽玫es -->
    <div id="modal-notificacoes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 sm:p-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Configura莽玫es de Notifica莽玫es</h3>
                <button type="button" id="btn-close-notificacoes-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-700">As notifica莽玫es ajudam voc锚 a lembrar de tomar seus medicamentos nos hor谩rios corretos.</p>
                </div>
                
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-semibold">Ativar Notifica莽玫es</p>
                        <p class="text-sm text-gray-600">Receber lembretes no navegador</p>
                    </div>
                    <button id="btn-toggle-notificacoes" class="w-14 h-8 bg-gray-300 rounded-full relative transition" data-enabled="false">
                        <span class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-transform"></span>
                    </button>
                </div>
                
                <div id="notificacao-status" class="p-4 rounded-lg hidden">
                    <p class="text-sm"></p>
                </div>
                
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-semibold">Lembrete Antecipado</p>
                        <p class="text-sm text-gray-600">Minutos antes do hor谩rio</p>
                    </div>
                    <select id="select-antecedencia" class="px-3 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="0">No hor谩rio</option>
                        <option value="5">5 minutos antes</option>
                        <option value="10" selected>10 minutos antes</option>
                        <option value="15">15 minutos antes</option>
                        <option value="30">30 minutos antes</option>
                    </select>
                </div>
                
                <button type="button" id="btn-testar-notificacao" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Testar Notifica莽茫o</button>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button type="button" id="btn-fechar-notificacoes" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Fechar</button>
            </div>
        </div>
    </div>
    
    <script>
    // ========================================
    // M脫DULO DE GERENCIAMENTO DE DADOS
    // ========================================
    const DataManager = {
        // Chaves de armazenamento
        KEYS: {
            TRATAMENTOS: 'tratamentos_v7',
            DOSES: 'dosesDiarias_v7',
            ULTIMA_GERACAO: 'ultimaGeracao_v7',
            DARK_MODE: 'darkMode_v7',
            NOTIFICACOES: 'notificacoesAtivadas_v7',
            ANTECEDENCIA: 'antecedenciaNotificacao_v7'
        },
        
        // Carregar tratamentos
        carregarTratamentos() {
            try {
                return JSON.parse(localStorage.getItem(this.KEYS.TRATAMENTOS)) || [];
            } catch (error) {
                console.error('Erro ao carregar tratamentos:', error);
                return [];
            }
        },
        
        // Salvar tratamentos
        salvarTratamentos(tratamentos) {
            try {
                localStorage.setItem(this.KEYS.TRATAMENTOS, JSON.stringify(tratamentos));
                return true;
            } catch (error) {
                console.error('Erro ao salvar tratamentos:', error);
                UI.mostrarToast('Erro ao salvar tratamentos', 'error');
                return false;
            }
        },
        
        // Carregar doses di谩rias
        carregarDoses() {
            try {
                return JSON.parse(localStorage.getItem(this.KEYS.DOSES)) || [];
            } catch (error) {
                console.error('Erro ao carregar doses:', error);
                return [];
            }
        },
        
        // Salvar doses di谩rias
        salvarDoses(doses) {
            try {
                localStorage.setItem(this.KEYS.DOSES, JSON.stringify(doses));
                return true;
            } catch (error) {
                console.error('Erro ao salvar doses:', error);
                return false;
            }
        },
        
        // Verificar se precisa gerar doses para hoje
        precisaGerarDosesHoje() {
            const hoje = new Date().toLocaleDateString('pt-BR');
            const ultimaGeracao = localStorage.getItem(this.KEYS.ULTIMA_GERACAO);
            return ultimaGeracao !== hoje;
        },
        
        // Marcar gera莽茫o de hoje como conclu铆da
        marcarGeracaoHoje() {
            const hoje = new Date().toLocaleDateString('pt-BR');
            localStorage.setItem(this.KEYS.ULTIMA_GERACAO, hoje);
        },
        
        // Carregar prefer锚ncia de modo escuro
        carregarDarkMode() {
            return localStorage.getItem(this.KEYS.DARK_MODE) === 'true';
        },
        
        // Salvar prefer锚ncia de modo escuro
        salvarDarkMode(ativado) {
            localStorage.setItem(this.KEYS.DARK_MODE, ativado.toString());
        },
        
        // Carregar configura莽茫o de notifica莽玫es
        carregarNotificacoes() {
            return localStorage.getItem(this.KEYS.NOTIFICACOES) === 'true';
        },
        
        // Salvar configura莽茫o de notifica莽玫es
        salvarNotificacoes(ativado) {
            localStorage.setItem(this.KEYS.NOTIFICACOES, ativado.toString());
        },
        
        // Carregar anteced锚ncia de notifica莽茫o
        carregarAntecedencia() {
            return parseInt(localStorage.getItem(this.KEYS.ANTECEDENCIA)) || 10;
        },
        
        // Salvar anteced锚ncia de notifica莽茫o
        salvarAntecedencia(minutos) {
            localStorage.setItem(this.KEYS.ANTECEDENCIA, minutos.toString());
        }
    };

    // ========================================
    // M脫DULO DE INTERFACE DO USU脕RIO
    // ========================================
    const UI = {
        // Mostrar toast de notifica莽茫o
        mostrarToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;
            toast.textContent = mensagem;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        },
        
        // Validar campo de formul谩rio
        validarCampo(campo, mensagemErro) {
            const errorElement = document.getElementById(`error-${campo.id}`);
            if (!campo.value.trim()) {
                campo.classList.add('input-error');
                if (errorElement) {
                    errorElement.textContent = mensagemErro;
                    errorElement.classList.remove('hidden');
                }
                return false;
            } else {
                campo.classList.remove('input-error');
                if (errorElement) {
                    errorElement.classList.add('hidden');
                }
                return true;
            }
        },
        
        // Limpar erros de valida莽茫o
        limparErros() {
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
        },
        
        // Alternar modo escuro
        toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            DataManager.salvarDarkMode(isDark);
            this.mostrarToast(`Modo ${isDark ? 'escuro' : 'claro'} ativado`, 'info');
        },
        
        // Aplicar modo escuro se necess谩rio
        aplicarDarkMode() {
            if (DataManager.carregarDarkMode()) {
                document.body.classList.add('dark-mode');
            }
        },
        
        // Formatar data para exibi莽茫o
        formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
        },
        
        // Formatar hor谩rio
        formatarHorario(horario) {
            return horario;
        },
        
        // Calcular tempo at茅 pr贸xima dose
        calcularTempoAteProximaDose(horario) {
            const agora = new Date();
            const [horas, minutos] = horario.split(':');
            const proximaDose = new Date();
            proximaDose.setHours(parseInt(horas), parseInt(minutos), 0, 0);
            
            if (proximaDose < agora) {
                proximaDose.setDate(proximaDose.getDate() + 1);
            }
            
            const diff = proximaDose - agora;
            const horasRestantes = Math.floor(diff / (1000 * 60 * 60));
            const minutosRestantes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (horasRestantes === 0) {
                return `em ${minutosRestantes} minutos`;
            } else if (horasRestantes < 24) {
                return `em ${horasRestantes}h ${minutosRestantes}min`;
            } else {
                return 'amanh茫';
            }
        }
    };

    // ========================================
    // M脫DULO DE NOTIFICA脟脮ES
    // ========================================
    const NotificationManager = {
        permissaoAtiva: false,
        intervaloVerificacao: null,
        
        // Verificar e solicitar permiss茫o
        async solicitarPermissao() {
            if (!('Notification' in window)) {
                UI.mostrarToast('Seu navegador n茫o suporta notifica莽玫es', 'error');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                this.permissaoAtiva = true;
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                this.permissaoAtiva = permission === 'granted';
                return this.permissaoAtiva;
            }
            
            return false;
        },
        
        // Enviar notifica莽茫o
        enviarNotificacao(titulo, corpo, icone = '馃拪') {
            if (!this.permissaoAtiva) return;
            
            try {
                const notification = new Notification(titulo, {
                    body: corpo,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">馃拪</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">馃拪</text></svg>',
                    tag: 'medicamento-lembrete',
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            } catch (error) {
                console.error('Erro ao enviar notifica莽茫o:', error);
            }
        },
        
        // Iniciar verifica莽茫o de hor谩rios
        iniciarVerificacao() {
            if (this.intervaloVerificacao) {
                clearInterval(this.intervaloVerificacao);
            }
            
            // Verificar a cada minuto
            this.intervaloVerificacao = setInterval(() => {
                this.verificarHorarios();
            }, 60000);
            
            // Verificar imediatamente
            this.verificarHorarios();
        },
        
        // Verificar hor谩rios para notifica莽玫es
        verificarHorarios() {
            if (!DataManager.carregarNotificacoes() || !this.permissaoAtiva) return;
            
            const doses = DataManager.carregarDoses();
            const agora = new Date();
            const antecedencia = DataManager.carregarAntecedencia();
            
            doses.forEach(dose => {
                if (dose.concluido) return;
                
                const [horas, minutos] = dose.horario.split(':');
                const horarioDose = new Date();
                horarioDose.setHours(parseInt(horas), parseInt(minutos) - antecedencia, 0, 0);
                
                // Verificar se est谩 no hor谩rio (com margem de 1 minuto)
                const diff = Math.abs(agora - horarioDose);
                if (diff < 60000) { // Menos de 1 minuto de diferen莽a
                    const titulo = `鈴� Hora do rem茅dio: ${dose.nome}`;
                    const corpo = `${dose.dosagem} - ${dose.horario}\n${dose.instrucoes}`;
                    this.enviarNotificacao(titulo, corpo);
                }
            });
        },
        
        // Parar verifica莽茫o
        pararVerificacao() {
            if (this.intervaloVerificacao) {
                clearInterval(this.intervaloVerificacao);
                this.intervaloVerificacao = null;
            }
        },
        
        // Atualizar badge de notifica莽玫es pendentes
        atualizarBadge() {
            const doses = DataManager.carregarDoses();
            const agora = new Date();
            let pendentes = 0;
            
            doses.forEach(dose => {
                if (dose.concluido) return;
                
                const [horas, minutos] = dose.horario.split(':');
                const horarioDose = new Date();
                horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0);
                
                if (horarioDose <= agora) {
                    pendentes++;
                }
            });
            
            const badge = document.getElementById('notification-badge');
            if (pendentes > 0) {
                badge.textContent = pendentes;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    };

    // ========================================
    // M脫DULO DE GERENCIAMENTO DE TRATAMENTOS
    // ========================================
    const TreatmentManager = {
        tratamentos: [],
        dosesDiarias: [],
        
        // Inicializar
        init() {
            this.tratamentos = DataManager.carregarTratamentos();
            
            if (DataManager.precisaGerarDosesHoje()) {
                this.gerarDosesParaHoje();
                DataManager.marcarGeracaoHoje();
            } else {
                this.dosesDiarias = DataManager.carregarDoses();
            }
        },
        
        // Gerar doses para hoje
        gerarDosesParaHoje() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            this.dosesDiarias = [];

            this.tratamentos.forEach(trat => {
                const dataInicio = new Date(trat.dataInicio);
                dataInicio.setHours(0, 0, 0, 0);
                
                const diffTime = hoje - dataInicio;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                // Verificar se 茅 tratamento cont铆nuo ou se ainda est谩 dentro da dura莽茫o
                const dentroDoTratamento = trat.tipotratamento === 'continuo' || 
                                          (diffDays >= 0 && diffDays < trat.duracao);

                if (dentroDoTratamento) {
                    trat.horarios.forEach(horario => {
                        this.dosesDiarias.push({
                            id: `${trat.id}-${horario}`,
                            tratamentoId: trat.id,
                            nome: trat.nome,
                            dosagem: trat.dosagem,
                            horario: horario,
                            instrucoes: trat.instrucoes,
                            diaAtual: trat.tipotratamento === 'continuo' ? '鈭�' : diffDays + 1,
                            duracaoTotal: trat.tipotratamento === 'continuo' ? '鈭�' : trat.duracao,
                            concluido: false
                        });
                    });
                }
            });
            
            DataManager.salvarDoses(this.dosesDiarias);
        },
        
        // Adicionar tratamento
        adicionarTratamento(dados) {
            const novoTratamento = {
                ...dados,
                id: Date.now().toString(),
                dataInicio: new Date().toISOString()
            };
            
            this.tratamentos.push(novoTratamento);
            
            if (DataManager.salvarTratamentos(this.tratamentos)) {
                this.gerarDosesParaHoje();
                DataManager.marcarGeracaoHoje();
                UI.mostrarToast('Tratamento adicionado com sucesso!', 'success');
                return true;
            }
            
            return false;
        },
        
        // Editar tratamento
        editarTratamento(id, dados) {
            const index = this.tratamentos.findIndex(t => t.id === id);
            if (index === -1) return false;
            
            this.tratamentos[index] = { 
                ...this.tratamentos[index], 
                ...dados 
            };
            
            if (DataManager.salvarTratamentos(this.tratamentos)) {
                this.gerarDosesParaHoje();
                DataManager.marcarGeracaoHoje();
                UI.mostrarToast('Tratamento atualizado com sucesso!', 'success');
                return true;
            }
            
            return false;
        },
        
        // Excluir tratamento
        excluirTratamento(id) {
            this.tratamentos = this.tratamentos.filter(t => t.id !== id);
            
            if (DataManager.salvarTratamentos(this.tratamentos)) {
                this.gerarDosesParaHoje();
                DataManager.marcarGeracaoHoje();
                UI.mostrarToast('Tratamento exclu铆do com sucesso!', 'success');
                return true;
            }
            
            return false;
        },
        
        // Marcar dose como conclu铆da/n茫o conclu铆da
        toggleDose(id) {
            const dose = this.dosesDiarias.find(d => d.id === id);
            if (!dose) return false;
            
            dose.concluido = !dose.concluido;
            DataManager.salvarDoses(this.dosesDiarias);
            
            if (dose.concluido) {
                UI.mostrarToast(`鉁� ${dose.nome} marcado como tomado!`, 'success');
            }
            
            return true;
        },
        
        // Obter pr贸xima dose
        obterProximaDose() {
            const agora = new Date();
            const dosesNaoConcluidas = this.dosesDiarias.filter(d => !d.concluido);
            
            if (dosesNaoConcluidas.length === 0) return null;
            
            // Ordenar por hor谩rio
            dosesNaoConcluidas.sort((a, b) => a.horario.localeCompare(b.horario));
            
            // Encontrar a pr贸xima dose
            for (const dose of dosesNaoConcluidas) {
                const [horas, minutos] = dose.horario.split(':');
                const horarioDose = new Date();
                horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0);
                
                if (horarioDose >= agora) {
                    return dose;
                }
            }
            
            // Se todas as doses de hoje j谩 passaram, retornar a primeira de amanh茫
            return dosesNaoConcluidas[0];
        },
        
        // Verificar se todas as doses foram conclu铆das
        todasDosesConcluidas() {
            return this.dosesDiarias.length > 0 && 
                   this.dosesDiarias.every(d => d.concluido);
        },
        
        // Obter estat铆sticas
        obterEstatisticas() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            let ativos = 0;
            let concluidos = 0;
            
            this.tratamentos.forEach(trat => {
                const dataInicio = new Date(trat.dataInicio);
                dataInicio.setHours(0, 0, 0, 0);
                
                const diffTime = hoje - dataInicio;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (trat.tipotratamento === 'continuo') {
                    ativos++;
                } else if (diffDays >= 0 && diffDays < trat.duracao) {
                    ativos++;
                } else if (diffDays >= trat.duracao) {
                    concluidos++;
                }
            });
            
            return {
                total: this.tratamentos.length,
                ativos,
                concluidos
            };
        }
    };

    // ========================================
    // M脫DULO DE RENDERIZA脟脙O
    // ========================================
    const Renderer = {
        // Renderizar doses di谩rias
        renderDosesDiarias() {
            const container = document.getElementById('checklist-container');
            const placeholder = document.getElementById('placeholder');
            
            container.innerHTML = '';
            
            if (TreatmentManager.dosesDiarias.length === 0) {
                placeholder.style.display = 'block';
                container.style.display = 'none';
                return;
            }
            
            placeholder.style.display = 'none';
            container.style.display = 'block';
            
            // Agrupar por per铆odo
            const groupedMeds = { 
                'Manh茫 鈽€锔�': [], 
                'Tarde 馃寚': [], 
                'Noite 馃寵': [] 
            };
            
            TreatmentManager.dosesDiarias.sort((a, b) => a.horario.localeCompare(b.horario));
            
            TreatmentManager.dosesDiarias.forEach(dose => {
                const hour = parseInt(dose.horario.split(':')[0], 10);
                if (hour >= 4 && hour < 12) groupedMeds['Manh茫 鈽€锔�'].push(dose);
                else if (hour >= 12 && hour < 18) groupedMeds['Tarde 馃寚'].push(dose);
                else groupedMeds['Noite 馃寵'].push(dose);
            });
            
            for (const periodo in groupedMeds) {
                if (groupedMeds[periodo].length > 0) {
                    const section = document.createElement('section');
                    section.className = 'fade-in-scale';
                    section.innerHTML = `<h2 class="text-3xl font-bold text-white pb-2 mb-4 drop-shadow-lg">${periodo}</h2>`;
                    groupedMeds[periodo].forEach(dose => section.appendChild(this.createMedCard(dose)));
                    container.appendChild(section);
                }
            }
            
            this.atualizarProgresso();
            this.atualizarProximaDose();
            NotificationManager.atualizarBadge();
        },
        
        // Criar card de medicamento
        createMedCard(dose) {
            const card = document.createElement('div');
            const agora = new Date();
            const [horas, minutos] = dose.horario.split(':');
            const horarioDose = new Date();
            horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0);
            
            let cardClass = 'bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg border-l-8 border-gray-300 transition-all duration-300 cursor-pointer p-5 flex items-center gap-5 fade-in-scale hover:shadow-xl hover:scale-[1.02]';
            
            if (dose.concluido) {
                cardClass += ' card-concluido';
            } else if (horarioDose < agora) {
                cardClass += ' card-atrasado';
            } else {
                const diff = horarioDose - agora;
                if (diff < 30 * 60 * 1000) { // Menos de 30 minutos
                    cardClass += ' card-proximo';
                }
            }
            
            card.className = cardClass;
            card.dataset.id = dose.id;
            
            const diaInfo = dose.duracaoTotal === '鈭�' 
                ? '(Cont铆nuo)' 
                : `(Dia ${dose.diaAtual}/${dose.duracaoTotal})`;
            
            card.innerHTML = `
                <div class="text-5xl flex-shrink-0">${dose.concluido ? '鉁�' : '猬滐笍'}</div>
                <div class="flex-grow info-remedio">
                    <h3 class="font-bold text-2xl">${dose.nome} <span class="text-lg font-medium text-gray-500">${diaInfo}</span></h3>
                    <p class="text-gray-600 text-lg mt-1">馃拪 ${dose.dosagem}</p>
                    <p class="text-gray-600 text-lg">鈴� ${dose.horario}</p>
                    <p class="text-gray-600 text-lg">馃嵔锔� ${dose.instrucoes}</p>
                </div>`;
            
            return card;
        },
        
        // Atualizar barra de progresso
        atualizarProgresso() {
            const total = TreatmentManager.dosesDiarias.length;
            const concluidos = TreatmentManager.dosesDiarias.filter(d => d.concluido).length;
            const percent = total > 0 ? Math.round((concluidos / total) * 100) : 0;
            
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = total > 0 ? `${percent}%` : '';
            progressText.textContent = total > 0 
                ? `Voc锚 tomou ${concluidos} de ${total} medicamentos hoje.` 
                : 'Nenhum medicamento para hoje.';
        },
        
        // Atualizar informa莽茫o da pr贸xima dose
        atualizarProximaDose() {
            const proximaDose = TreatmentManager.obterProximaDose();
            const container = document.getElementById('next-dose-info');
            const text = document.getElementById('next-dose-text');
            
            if (proximaDose) {
                const tempo = UI.calcularTempoAteProximaDose(proximaDose.horario);
                text.textContent = `${proximaDose.nome} 脿s ${proximaDose.horario} (${tempo})`;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        },
        
        // Renderizar relat贸rio
        renderRelatorio() {
            const conteudo = document.getElementById('relatorio-conteudo');
            document.getElementById('relatorio-data').textContent = new Date().toLocaleDateString('pt-BR');
            
            conteudo.innerHTML = '';
            
            if (TreatmentManager.tratamentos.length === 0) {
                conteudo.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum tratamento cadastrado.</p>';
                return;
            }
            
            // Atualizar estat铆sticas
            const stats = TreatmentManager.obterEstatisticas();
            document.getElementById('stats-total').textContent = stats.total;
            document.getElementById('stats-ativos').textContent = stats.ativos;
            document.getElementById('stats-concluidos').textContent = stats.concluidos;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            TreatmentManager.tratamentos.forEach(trat => {
                const dataInicio = new Date(trat.dataInicio);
                dataInicio.setHours(0, 0, 0, 0);
                const diffTime = hoje - dataInicio;
                const diasPassados = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                
                let diaAtual, progresso, statusBadge;
                
                if (trat.tipotratamento === 'continuo') {
                    diaAtual = '鈭�';
                    progresso = 100;
                    statusBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">Cont铆nuo</span>';
                } else {
                    diaAtual = Math.min(diasPassados + 1, trat.duracao);
                    progresso = Math.min(100, Math.round((diaAtual / trat.duracao) * 100));
                    
                    if (diaAtual >= trat.duracao) {
                        statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">Conclu铆do</span>';
                    } else {
                        statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-semibold">Em andamento</span>';
                    }
                }

                const itemRelatorio = document.createElement('div');
                itemRelatorio.className = 'p-5 border-2 border-gray-200 rounded-xl relative hover:border-blue-300 transition bg-gradient-to-r from-white to-gray-50';
                itemRelatorio.innerHTML = `
                    <div class="absolute top-3 right-3 flex gap-2 no-print">
                        <button class="btn-edit btn-icon p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" data-id="${trat.id}" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="btn-delete btn-icon p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition" data-id="${trat.id}" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div class="pr-20">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="font-bold text-xl">${trat.nome}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-gray-600 mb-1"><span class="font-semibold">Dose:</span> ${trat.dosagem}</p>
                        <p class="text-gray-600 mb-1"><span class="font-semibold">Hor谩rios:</span> ${trat.horarios.join(', ')}</p>
                        <p class="text-gray-600 mb-1"><span class="font-semibold">Instru莽玫es:</span> ${trat.instrucoes}</p>
                        <p class="text-sm text-gray-500 mt-2">In铆cio: ${dataInicio.toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-base font-semibold text-blue-700">
                                ${trat.tipotratamento === 'continuo' ? 'Tratamento Cont铆nuo' : `Dia ${diaAtual} de ${trat.duracao}`}
                            </span>
                            <span class="font-bold text-lg">${progresso}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${progresso}%"></div>
                        </div>
                    </div>`;
                conteudo.appendChild(itemRelatorio);
            });
        }
    };

    // ========================================
    // M脫DULO DE FORMUL脕RIO
    // ========================================
    const FormManager = {
        // Limpar formul谩rio
        limparFormulario() {
            document.getElementById('form-remedio').reset();
            document.getElementById('tratamento-id').value = '';
            document.getElementById('modal-title').textContent = 'Novo Tratamento';
            document.getElementById('horarios-container').innerHTML = '';
            document.getElementById('instrucoes-personalizadas-container').classList.add('hidden');
            document.getElementById('duracao-container').style.display = 'block';
            UI.limparErros();
            this.adicionarCampoHorario();
        },
        
        // Adicionar campo de hor谩rio
        adicionarCampoHorario(horario = '') {
            const container = document.getElementById('horarios-container');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="time" value="${horario}" required class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                <button type="button" class="btn-remove-horario text-red-500 hover:text-red-700 hover:bg-red-50 font-bold text-2xl px-3 py-2 rounded-lg transition">脳</button>`;
            container.appendChild(div);
            
            div.querySelector('.btn-remove-horario').addEventListener('click', () => {
                if (container.children.length > 1) {
                    div.remove();
                } else {
                    UI.mostrarToast('脡 necess谩rio pelo menos um hor谩rio', 'error');
                }
            });
        },
        
        // Preencher hor谩rios por sugest茫o
        preencherHorariosSugestao(intervalo) {
            const container = document.getElementById('horarios-container');
            container.innerHTML = '';
            
            const numDoses = 24 / intervalo;
            for (let i = 0; i < numDoses; i++) {
                const hora = (8 + (i * intervalo)) % 24; // Come莽ar 脿s 8h
                const horarioFormatado = `${hora.toString().padStart(2, '0')}:00`;
                this.adicionarCampoHorario(horarioFormatado);
            }
            
            UI.mostrarToast(`Hor谩rios sugeridos adicionados (a cada ${intervalo}h)`, 'info');
        },
        
        // Validar formul谩rio
        validarFormulario() {
            let valido = true;
            
            const nomeRemedio = document.getElementById('nome-remedio');
            if (!UI.validarCampo(nomeRemedio, 'Por favor, informe o nome do rem茅dio')) {
                valido = false;
            }
            
            const dosagemRemedio = document.getElementById('dosagem-remedio');
            if (!UI.validarCampo(dosagemRemedio, 'Por favor, informe a dosagem')) {
                valido = false;
            }
            
            const tipoTratamento = document.getElementById('tipo-tratamento').value;
            if (tipoTratamento === 'temporario') {
                const duracaoTratamento = document.getElementById('duracao-tratamento');
                if (!duracaoTratamento.value || parseInt(duracaoTratamento.value) < 1) {
                    duracaoTratamento.classList.add('input-error');
                    document.getElementById('error-duracao-tratamento').textContent = 'Informe a dura莽茫o do tratamento';
                    document.getElementById('error-duracao-tratamento').classList.remove('hidden');
                    valido = false;
                }
            }
            
            const horarios = Array.from(document.querySelectorAll('#horarios-container input[type="time"]'))
                .map(input => input.value)
                .filter(Boolean);
            
            if (horarios.length === 0) {
                document.getElementById('error-horarios').textContent = 'Adicione pelo menos um hor谩rio';
                document.getElementById('error-horarios').classList.remove('hidden');
                valido = false;
            } else {
                document.getElementById('error-horarios').classList.add('hidden');
            }
            
            return valido;
        },
        
        // Coletar dados do formul谩rio
        coletarDados() {
            const tipoTratamento = document.getElementById('tipo-tratamento').value;
            const instrucoesSelect = document.getElementById('instrucoes-remedio').value;
            
            let instrucoes = instrucoesSelect;
            if (instrucoesSelect === 'personalizado') {
                instrucoes = document.getElementById('instrucoes-personalizadas').value.trim() || 'Conforme orienta莽茫o m茅dica';
            }
            
            const horarios = Array.from(document.querySelectorAll('#horarios-container input[type="time"]'))
                .map(input => input.value)
                .filter(Boolean)
                .sort();
            
            return {
                nome: document.getElementById('nome-remedio').value.trim(),
                dosagem: document.getElementById('dosagem-remedio').value.trim(),
                tipotratamento: tipoTratamento,
                duracao: tipoTratamento === 'temporario' ? parseInt(document.getElementById('duracao-tratamento').value) : 999999,
                horarios: horarios,
                instrucoes: instrucoes
            };
        },
        
        // Preencher formul谩rio para edi莽茫o
        preencherFormulario(id) {
            const trat = TreatmentManager.tratamentos.find(t => t.id === id);
            if (!trat) return;
            
            document.getElementById('tratamento-id').value = trat.id;
            document.getElementById('modal-title').textContent = 'Editar Tratamento';
            document.getElementById('nome-remedio').value = trat.nome;
            document.getElementById('dosagem-remedio').value = trat.dosagem;
            document.getElementById('tipo-tratamento').value = trat.tipotratamento || 'temporario';
            
            if (trat.tipotratamento === 'continuo') {
                document.getElementById('duracao-container').style.display = 'none';
            } else {
                document.getElementById('duracao-tratamento').value = trat.duracao;
                document.getElementById('duracao-container').style.display = 'block';
            }
            
            // Verificar se 茅 instru莽茫o personalizada
            const opcoesInstrucoes = Array.from(document.querySelectorAll('#instrucoes-remedio option')).map(opt => opt.value);
            if (opcoesInstrucoes.includes(trat.instrucoes)) {
                document.getElementById('instrucoes-remedio').value = trat.instrucoes;
            } else {
                document.getElementById('instrucoes-remedio').value = 'personalizado';
                document.getElementById('instrucoes-personalizadas').value = trat.instrucoes;
                document.getElementById('instrucoes-personalizadas-container').classList.remove('hidden');
            }
            
            document.getElementById('horarios-container').innerHTML = '';
            trat.horarios.forEach(h => this.adicionarCampoHorario(h));
        }
    };

    // ========================================
    // M脫DULO DE EXPORTA脟脙O
    // ========================================
    const ExportManager = {
        // Exportar para CSV
        exportarCSV() {
            if (TreatmentManager.tratamentos.length === 0) {
                UI.mostrarToast('Nenhum tratamento para exportar', 'error');
                return;
            }
            
            let csv = 'Nome,Dosagem,Tipo,Dura莽茫o (dias),Hor谩rios,Instru莽玫es,Data de In铆cio\n';
            
            TreatmentManager.tratamentos.forEach(trat => {
                const tipo = trat.tipotratamento === 'continuo' ? 'Cont铆nuo' : 'Tempor谩rio';
                const duracao = trat.tipotratamento === 'continuo' ? 'N/A' : trat.duracao;
                const horarios = trat.horarios.join('; ');
                const dataInicio = new Date(trat.dataInicio).toLocaleDateString('pt-BR');
                
                csv += `"${trat.nome}","${trat.dosagem}","${tipo}","${duracao}","${horarios}","${trat.instrucoes}","${dataInicio}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `tratamentos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            UI.mostrarToast('Relat贸rio exportado com sucesso!', 'success');
        }
    };

    // ========================================
    // INICIALIZA脟脙O DA APLICA脟脙O
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        // Aplicar modo escuro se necess谩rio
        UI.aplicarDarkMode();
        
        // Inicializar gerenciador de tratamentos
        TreatmentManager.init();
        
        // Renderizar interface
        document.getElementById('current-date').textContent = UI.formatarData(new Date());
        Renderer.renderDosesDiarias();
        
        // Inicializar notifica莽玫es se estiverem ativadas
        if (DataManager.carregarNotificacoes()) {
            NotificationManager.solicitarPermissao().then(permitido => {
                if (permitido) {
                    NotificationManager.iniciarVerificacao();
                }
            });
        }
        
        // ========================================
        // EVENT LISTENERS
        // ========================================
        
        // Bot茫o de modo escuro
        document.getElementById('btn-toggle-dark').addEventListener('click', () => {
            UI.toggleDarkMode();
        });
        
        // Bot茫o de notifica莽玫es
        document.getElementById('btn-notifications').addEventListener('click', () => {
            document.getElementById('modal-notificacoes').classList.remove('hidden');
            
            // Atualizar estado do toggle
            const btnToggle = document.getElementById('btn-toggle-notificacoes');
            const ativado = DataManager.carregarNotificacoes();
            btnToggle.dataset.enabled = ativado.toString();
            
            if (ativado) {
                btnToggle.classList.remove('bg-gray-300');
                btnToggle.classList.add('bg-blue-600');
                btnToggle.querySelector('span').style.transform = 'translateX(24px)';
            }
            
            // Atualizar anteced锚ncia
            document.getElementById('select-antecedencia').value = DataManager.carregarAntecedencia().toString();
        });
        
        // Toggle de notifica莽玫es
        document.getElementById('btn-toggle-notificacoes').addEventListener('click', async function() {
            const ativado = this.dataset.enabled === 'true';
            
            if (!ativado) {
                const permitido = await NotificationManager.solicitarPermissao();
                if (permitido) {
                    this.dataset.enabled = 'true';
                    this.classList.remove('bg-gray-300');
                    this.classList.add('bg-blue-600');
                    this.querySelector('span').style.transform = 'translateX(24px)';
                    DataManager.salvarNotificacoes(true);
                    NotificationManager.iniciarVerificacao();
                    UI.mostrarToast('Notifica莽玫es ativadas!', 'success');
                } else {
                    UI.mostrarToast('Permiss茫o de notifica莽玫es negada', 'error');
                }
            } else {
                this.dataset.enabled = 'false';
                this.classList.remove('bg-blue-600');
                this.classList.add('bg-gray-300');
                this.querySelector('span').style.transform = 'translateX(0)';
                DataManager.salvarNotificacoes(false);
                NotificationManager.pararVerificacao();
                UI.mostrarToast('Notifica莽玫es desativadas', 'info');
            }
        });
        
        // Alterar anteced锚ncia de notifica莽茫o
        document.getElementById('select-antecedencia').addEventListener('change', function() {
            DataManager.salvarAntecedencia(parseInt(this.value));
            UI.mostrarToast('Anteced锚ncia atualizada', 'info');
        });
        
        // Testar notifica莽茫o
        document.getElementById('btn-testar-notificacao').addEventListener('click', () => {
            if (NotificationManager.permissaoAtiva) {
                NotificationManager.enviarNotificacao(
                    '馃拪 Teste de Notifica莽茫o',
                    'Se voc锚 est谩 vendo isso, as notifica莽玫es est茫o funcionando perfeitamente!'
                );
            } else {
                UI.mostrarToast('Ative as notifica莽玫es primeiro', 'error');
            }
        });
        
        // Fechar modal de notifica莽玫es
        document.getElementById('btn-fechar-notificacoes').addEventListener('click', () => {
            document.getElementById('modal-notificacoes').classList.add('hidden');
        });
        
        document.getElementById('btn-close-notificacoes-x').addEventListener('click', () => {
            document.getElementById('modal-notificacoes').classList.add('hidden');
        });
        
        // Abrir modal de adicionar tratamento
        document.getElementById('btn-open-modal').addEventListener('click', () => {
            FormManager.limparFormulario();
            document.getElementById('med-modal').classList.remove('hidden');
        });
        
        // Fechar modal de tratamento
        document.getElementById('btn-cancel-modal').addEventListener('click', () => {
            document.getElementById('med-modal').classList.add('hidden');
        });
        
        document.getElementById('btn-close-modal-x').addEventListener('click', () => {
            document.getElementById('med-modal').classList.add('hidden');
        });
        
        // Adicionar hor谩rio manualmente
        document.getElementById('btn-add-horario').addEventListener('click', () => {
            FormManager.adicionarCampoHorario();
        });
        
        // Sugest玫es de hor谩rios
        document.querySelectorAll('.btn-sugestao').forEach(btn => {
            btn.addEventListener('click', () => {
                const intervalo = parseInt(btn.dataset.intervalo);
                FormManager.preencherHorariosSugestao(intervalo);
            });
        });
        
        // Alterar tipo de tratamento
        document.getElementById('tipo-tratamento').addEventListener('change', function() {
            const duracaoContainer = document.getElementById('duracao-container');
            if (this.value === 'continuo') {
                duracaoContainer.style.display = 'none';
                document.getElementById('duracao-tratamento').removeAttribute('required');
            } else {
                duracaoContainer.style.display = 'block';
                document.getElementById('duracao-tratamento').setAttribute('required', 'required');
            }
        });
        
        // Alterar instru莽玫es
        document.getElementById('instrucoes-remedio').addEventListener('change', function() {
            const container = document.getElementById('instrucoes-personalizadas-container');
            if (this.value === 'personalizado') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        });
        
        // Submeter formul谩rio
        document.getElementById('form-remedio').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!FormManager.validarFormulario()) {
                UI.mostrarToast('Por favor, preencha todos os campos obrigat贸rios', 'error');
                return;
            }
            
            const id = document.getElementById('tratamento-id').value;
            const dados = FormManager.coletarDados();
            
            let sucesso;
            if (id) {
                sucesso = TreatmentManager.editarTratamento(id, dados);
            } else {
                sucesso = TreatmentManager.adicionarTratamento(dados);
            }
            
            if (sucesso) {
                Renderer.renderDosesDiarias();
                document.getElementById('med-modal').classList.add('hidden');
            }
        });
        
        // Clicar em card de dose
        document.getElementById('checklist-container').addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (card) {
                TreatmentManager.toggleDose(card.dataset.id);
                Renderer.renderDosesDiarias();
                
                // Verificar se todas as doses foram conclu铆das
                if (TreatmentManager.todasDosesConcluidas()) {
                    document.getElementById('modal-conclusao').classList.remove('hidden');
                }
            }
        });
        
        // Fechar modal de conclus茫o
        document.getElementById('btn-reset').addEventListener('click', () => {
            document.getElementById('modal-conclusao').classList.add('hidden');
        });
        
        // Abrir relat贸rio
        document.getElementById('btn-open-relatorio').addEventListener('click', () => {
            Renderer.renderRelatorio();
            document.getElementById('relatorio-modal').classList.remove('hidden');
        });
        
        // Fechar relat贸rio
        document.getElementById('btn-fechar-relatorio').addEventListener('click', () => {
            document.getElementById('relatorio-modal').classList.add('hidden');
        });
        
        document.getElementById('btn-close-relatorio-x').addEventListener('click', () => {
            document.getElementById('relatorio-modal').classList.add('hidden');
        });
        
        // Imprimir relat贸rio
        document.getElementById('btn-salvar-relatorio').addEventListener('click', () => {
            window.print();
        });
        
        // Exportar CSV
        document.getElementById('btn-exportar-csv').addEventListener('click', () => {
            ExportManager.exportarCSV();
        });
        
        // Editar tratamento do relat贸rio
        document.getElementById('relatorio-conteudo').addEventListener('click', (e) => {
            const btnEdit = e.target.closest('.btn-edit');
            const btnDelete = e.target.closest('.btn-delete');
            
            if (btnEdit) {
                const id = btnEdit.dataset.id;
                FormManager.preencherFormulario(id);
                document.getElementById('relatorio-modal').classList.add('hidden');
                document.getElementById('med-modal').classList.remove('hidden');
            }
            
            if (btnDelete) {
                const id = btnDelete.dataset.id;
                window.idParaExcluir = id;
                document.getElementById('modal-confirmar-exclusao').classList.remove('hidden');
            }
        });
        
        // Confirmar exclus茫o
        document.getElementById('btn-confirmar-exclusao').addEventListener('click', () => {
            if (window.idParaExcluir) {
                TreatmentManager.excluirTratamento(window.idParaExcluir);
                Renderer.renderDosesDiarias();
                Renderer.renderRelatorio();
                window.idParaExcluir = null;
            }
            document.getElementById('modal-confirmar-exclusao').classList.add('hidden');
        });
        
        // Cancelar exclus茫o
        document.getElementById('btn-cancelar-exclusao').addEventListener('click', () => {
            window.idParaExcluir = null;
            document.getElementById('modal-confirmar-exclusao').classList.add('hidden');
        });
        
        // Atualizar pr贸xima dose a cada minuto
        setInterval(() => {
            Renderer.atualizarProximaDose();
            NotificationManager.atualizarBadge();
        }, 60000);
    });
    </script>
</body>
</html>
