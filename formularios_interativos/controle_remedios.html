<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Enfermeiro Inteligente</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .dark-mode { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .btn-principal, .btn-secundario, .btn-icon { transition: all 0.2s ease-in-out; }
        .btn-principal:active, .btn-secundario:active, .btn-icon:active { transform: scale(0.95); filter: brightness(0.9); }
        .fade-in-scale { animation: fadeInScale 0.4s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .card-concluido { background-color: #e8f5e9; border-left-color: #4caf50; opacity: 0.8; }
        .dark-mode .card-concluido { background-color: #2f4431; border-left-color: #66bb6a; }
        .card-concluido .info-remedio { text-decoration: line-through; color: #555; }
        .dark-mode .card-concluido .info-remedio { color: #a0aec0; }
        .card-atrasado { border-left-color: #f44336; background-color: #ffebee; }
        .dark-mode .card-atrasado { background-color: #5c2b2b; border-left-color: #ef5350; }
        .card-proximo { border-left-color: #ff9800; background-color: #fff3e0; animation: pulse 2s infinite; }
        .dark-mode .card-proximo { background-color: #6d4c22; border-left-color: #ffa726; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { background-color: #4caf50; color: white; }
        .toast-error { background-color: #f44336; color: white; }
        .toast-info { background-color: #2196f3; color: white; }
        .input-error { border-color: #f44336 !important; background-color: #ffebee !important; }
        .error-message { color: #f44336; font-size: 0.875rem; margin-top: 0.25rem; }
        @media print { body * { visibility: hidden; } #relatorio-imprimir, #relatorio-imprimir * { visibility: visible; } #relatorio-imprimir { position: absolute; left: 0; top: 0; width: 100%; } .no-print { display: none; } }
        .dark-mode .bg-white { background-color: #2d3748 !important; color: #e2e8f0; }
        .dark-mode .bg-gray-50 { background-color: #262f3d !important; }
        .dark-mode .bg-gray-100 { background-color: #374151 !important; }
        .dark-mode .bg-gray-200 { background-color: #4a5568 !important; }
        .dark-mode .text-gray-900 { color: #e2e8f0 !important; }
        .dark-mode .text-gray-600 { color: #cbd5e0 !important; }
        .dark-mode .text-gray-500 { color: #a0aec0 !important; }
        .dark-mode .text-gray-400 { color: #718096 !important; }
        .dark-mode .border-gray-300 { border-color: #4a5568 !important; }
        .dark-mode .bg-blue-50 { background-color: #2c3a57 !important; }
        .dark-mode .bg-purple-50 { background-color: #3c3658 !important; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background-color: #f44336; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }
        #auth-container { display: flex; align-items: center; gap: 1rem; }
        #app-content { display: none; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 24px; height: 24px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-900">

    <div id="login-container" class="container mx-auto max-w-md p-6 text-center mt-20">
        <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-8 shadow-2xl">
            <span class="text-6xl">💊</span>
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-800 mt-4">Meu Enfermeiro Inteligente</h1>
            <p class="text-gray-600 text-lg mt-2 mb-8">Faça login para gerenciar os tratamentos.</p>
            <button id="btn-login" class="btn-principal bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg text-xl flex items-center justify-center gap-3 w-full hover:bg-blue-700 transition">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                <span id="login-text">Login com Google</span>
                <div id="login-spinner" class="spinner hidden"></div>
            </button>
        </div>
    </div>

    <div id="app-content" class="container mx-auto max-w-4xl p-4 sm:p-6">
        <header class="text-center mb-8 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div id="auth-container"></div>
                <div class="flex gap-2">
                    <button id="btn-toggle-dark" class="btn-icon p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition" title="Alternar modo escuro">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                    <button id="btn-notifications" class="btn-icon p-3 bg-gray-200 rounded-full hover:bg-gray-300 transition relative" title="Configurar notificações">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                    </button>
                </div>
            </div>
            <div class="mt-4 p-4 bg-blue-50 rounded-lg flex flex-col sm:flex-row items-center gap-4">
                <label for="user-selector" class="text-lg font-semibold text-blue-800">Paciente:</label>
                <select id="user-selector" class="flex-grow mt-1 w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-blue-500 transition"></select>
                <button id="btn-manage-users" class="btn-secundario bg-white text-blue-600 border-2 border-blue-500 font-bold py-2 px-4 rounded-full shadow-sm text-md hover:bg-blue-50 transition">Gerenciar</button>
            </div>
            <p class="text-gray-600 text-lg mt-4">Hoje é <span id="current-date" class="font-semibold"></span></p>
        </header>

        <main id="checklist-container" class="space-y-10"></main>
        
        <div id="placeholder" class="text-center bg-white/90 backdrop-blur-sm p-10 rounded-2xl shadow-xl mt-10">
            <div id="placeholder-icon" class="text-6xl mb-4">👥</div>
            <p id="placeholder-title" class="mt-4 text-xl text-gray-600 font-semibold">Selecione ou crie um perfil de paciente para começar.</p>
            <p id="placeholder-subtitle" class="text-gray-500 mt-2">Use o menu "Paciente" acima para gerenciar os perfis.</p>
        </div>
        
        <footer id="footer-progress" class="mt-12 bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold mb-3 text-center">Progresso do Dia</h3>
            <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-green-600 h-6 rounded-full transition-all duration-500 flex items-center justify-center text-white font-bold text-sm" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-lg text-gray-600 mt-3 text-center"></p>
            <div id="next-dose-info" class="mt-4 p-4 bg-blue-50 rounded-lg text-center hidden">
                <p class="text-sm text-gray-600">Próxima dose:</p>
                <p class="text-lg font-bold text-blue-700" id="next-dose-text"></p>
            </div>
        </footer>

        <div class="mt-8 text-center text-white/80 text-sm">
            <p>Desenvolvido com 🤖 por thIAguinho Soluções</p>
        </div>
    </div>
    
    <div id="med-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all max-h-[90vh] overflow-y-auto" id="modal-content"><form id="form-remedio" class="p-6 sm:p-8 space-y-5"><input type="hidden" id="tratamento-id"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold">Novo Tratamento</h2><button type="button" id="btn-close-modal-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><div><label for="nome-remedio" class="block text-lg font-medium mb-1">Nome do Remédio *</label><input type="text" id="nome-remedio" placeholder="Ex: Azitromicina" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><p class="error-message hidden" id="error-nome-remedio"></p></div><div><label for="dosagem-remedio" class="block text-lg font-medium mb-1">Dose *</label><input type="text" id="dosagem-remedio" placeholder="Ex: 1 comprimido de 500mg" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><p class="error-message hidden" id="error-dosagem-remedio"></p></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="tipo-tratamento" class="block text-lg font-medium mb-1">Tipo de Tratamento *</label><select id="tipo-tratamento" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><option value="temporario">Temporário (por X dias)</option><option value="continuo">Contínuo (sem data fim)</option></select></div><div id="duracao-container"><label for="duracao-tratamento" class="block text-lg font-medium mb-1">Duração (dias) *</label><input type="number" id="duracao-tratamento" placeholder="Ex: 5" min="1" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><p class="error-message hidden" id="error-duracao-tratamento"></p></div></div><div><label class="block text-lg font-medium mb-2">Horários *</label><div class="mb-3 p-4 bg-blue-50 rounded-lg"><p class="text-sm text-gray-700 mb-2 font-medium">Sugestões rápidas:</p><div class="flex flex-wrap gap-2"><button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="24">1x ao dia</button><button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="12">A cada 12h</button><button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="8">A cada 8h</button><button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="6">A cada 6h</button><button type="button" class="btn-sugestao px-3 py-1 bg-white border border-blue-300 rounded-full text-sm hover:bg-blue-100 transition" data-intervalo="4">A cada 4h</button></div></div><div id="horarios-container" class="space-y-2"></div><button type="button" id="btn-add-horario" class="mt-2 w-full text-blue-600 font-semibold border-2 border-dashed border-blue-400 rounded-lg py-2 hover:bg-blue-50 transition">+ Adicionar horário manualmente</button><p class="error-message hidden" id="error-horarios"></p></div><div><label for="instrucoes-remedio" class="block text-lg font-medium mb-1">Como tomar? *</label><select id="instrucoes-remedio" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><option value="Depois de comer">Depois de comer 🍳</option><option value="Antes de comer (jejum)">Antes de comer (jejum) 🕒</option><option value="Com bastante água">Com bastante água 💧</option><option value="Com alimentos">Com alimentos 🍽️</option><option value="Sublingual">Sublingual 👅</option><option value="Uso tópico">Uso tópico 🧴</option><option value="Não importa">Não importa 👍</option><option value="personalizado">Personalizado ✏️</option></select></div><div id="instrucoes-personalizadas-container" class="hidden"><label for="instrucoes-personalizadas" class="block text-lg font-medium mb-1">Instruções Personalizadas</label><textarea id="instrucoes-personalizadas" placeholder="Digite instruções específicas..." class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" rows="3"></textarea></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" id="btn-cancel-modal" class="px-8 py-3 bg-gray-200 rounded-lg text-lg hover:bg-gray-300 transition">Cancelar</button><button type="submit" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg text-lg hover:bg-blue-700 transition">Salvar Tratamento</button></div></form></div></div>
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 sm:p-8"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Gerenciar Pacientes</h3><button type="button" id="btn-close-user-modal-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><form id="form-add-user" class="flex flex-col sm:flex-row items-stretch gap-2 mb-6"><input type="text" id="new-user-name" placeholder="Nome do novo paciente" required class="flex-grow px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500"><button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Adicionar</button></form><div id="user-list-container" class="space-y-2 max-h-60 overflow-y-auto"></div><div class="mt-6 flex justify-end"><button type="button" id="btn-close-user-modal" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Fechar</button></div></div></div>
    <div id="relatorio-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all flex flex-col" style="max-height: 90vh;"><div id="relatorio-imprimir" class="p-6 sm:p-8"><div class="flex justify-between items-center mb-4"><div><h2 class="text-2xl font-bold">Relatório de Tratamento</h2><p class="text-gray-500 mt-1">Progresso geral até <span id="relatorio-data"></span></p></div><button type="button" id="btn-close-relatorio-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none no-print">&times;</button></div><div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg"><div class="grid grid-cols-3 gap-4 text-center"><div><p class="text-2xl font-bold text-blue-600" id="stats-total">0</p><p class="text-sm text-gray-600">Total de Tratamentos</p></div><div><p class="text-2xl font-bold text-green-600" id="stats-ativos">0</p><p class="text-sm text-gray-600">Ativos</p></div><div><p class="text-2xl font-bold text-purple-600" id="stats-concluidos">0</p><p class="text-sm text-gray-600">Concluídos</p></div></div></div><div id="relatorio-conteudo" class="space-y-4 overflow-y-auto" style="max-height: 50vh;"></div></div><div class="flex justify-between gap-4 p-4 bg-gray-50 border-t rounded-b-2xl no-print"><button type="button" id="btn-exportar-csv" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Exportar CSV</button><div class="flex gap-2"><button type="button" id="btn-fechar-relatorio" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Fechar</button><button type="button" id="btn-salvar-relatorio" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Imprimir</button></div></div></div></div>
    <div id="modal-conclusao" class="fixed inset-0 bg-gradient-to-br from-green-500 to-green-700 bg-opacity-95 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div class="text-center text-white"><div class="text-9xl animate-bounce mb-6">🎉</div><h2 class="text-4xl sm:text-5xl font-bold mt-4">Parabéns!</h2><p class="text-xl sm:text-2xl mt-4 max-w-lg">Você tomou todos os medicamentos de hoje! Continue assim! 👏</p><div class="mt-8 p-6 bg-white/20 rounded-2xl backdrop-blur-sm"><p class="text-lg">Seu compromisso com a saúde é inspirador!</p></div><button id="btn-reset" class="btn-principal mt-10 bg-white text-green-600 font-bold py-4 px-8 rounded-full shadow-lg text-xl hover:bg-gray-100 transition">Entendido</button></div></div>
    <div id="modal-confirmar-exclusao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 sm:p-8"><div class="text-center"><div class="text-6xl mb-4">⚠️</div><h3 class="text-2xl font-bold mb-2">Confirmar Exclusão</h3><p class="text-gray-600 mb-6">Tem certeza que deseja excluir este tratamento? Esta ação não pode ser desfeita.</p><div class="flex gap-4 justify-center"><button type="button" id="btn-cancelar-exclusao" class="px-6 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button type="button" id="btn-confirmar-exclusao" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">Sim, Excluir</button></div></div></div></div>
    <div id="modal-notificacoes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 sm:p-8"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">Configurações de Notificações</h3><button type="button" id="btn-close-notificacoes-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><div class="space-y-4"><div class="p-4 bg-blue-50 rounded-lg"><p class="text-sm text-gray-700">As notificações ajudam a lembrar de tomar os medicamentos nos horários corretos.</p><p class="text-xs text-gray-600 mt-2"><strong>Importante:</strong> Em celulares, para garantir o recebimento, mantenha o navegador aberto em segundo plano.</p></div><div id="notificacao-status" class="p-4 rounded-lg hidden text-center"><p class="text-sm font-medium"></p></div><div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"><div><p class="font-semibold">Ativar Notificações</p><p class="text-sm text-gray-600">Receber lembretes no navegador</p></div><button id="btn-toggle-notificacoes" class="w-14 h-8 bg-gray-300 rounded-full relative transition" data-enabled="false"><span class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-transform"></span></button></div><div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"><div><p class="font-semibold">Lembrete Antecipado</p><p class="text-sm text-gray-600">Minutos antes do horário</p></div><select id="select-antecedencia" class="px-3 py-2 border border-gray-300 rounded-lg bg-white"><option value="0">No horário</option><option value="5">5 minutos antes</option><option value="10" selected>10 minutos antes</option><option value="15">15 minutos antes</option><option value="30">30 minutos antes</option></select></div><button type="button" id="btn-testar-notificacao" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Testar Notificação</button></div><div class="mt-6 flex justify-end"><button type="button" id="btn-fechar-notificacoes" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Fechar</button></div></div></div>

<script>
    // ========================================
    // FIREBASE CONFIGURATION
    // ========================================
    const firebaseConfig = {
        apiKey: "SUA_API_KEY",
        authDomain: "SEU_AUTH_DOMAIN",
        databaseURL: "SUA_DATABASE_URL",
        projectId: "SEU_PROJECT_ID",
        storageBucket: "SEU_STORAGE_BUCKET",
        messagingSenderId: "SEU_MESSAGING_SENDER_ID",
        appId: "SEU_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // ========================================
    // MÓDULOS DA APLICAÇÃO (COMPLETOS E REATORADOS)
    // ========================================

    const UI = {
        mostrarToast(mensagem, tipo = 'info') { const toast = document.createElement('div'); toast.className = `toast toast-${tipo}`; toast.textContent = mensagem; document.body.appendChild(toast); setTimeout(() => { toast.style.animation = 'slideInRight 0.3s ease-out reverse'; setTimeout(() => toast.remove(), 300); }, 3000); },
        validarCampo(campo, mensagemErro) { const errorElement = document.getElementById(`error-${campo.id}`); if (!campo.value.trim()) { campo.classList.add('input-error'); if (errorElement) { errorElement.textContent = mensagemErro; errorElement.classList.remove('hidden'); } return false; } else { campo.classList.remove('input-error'); if (errorElement) { errorElement.classList.add('hidden'); } return true; } },
        limparErros() { document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error')); document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden')); },
        toggleDarkMode() { const isDark = document.body.classList.toggle('dark-mode'); DataManager.salvarDarkMode(isDark); },
        aplicarDarkMode() { if (DataManager.carregarDarkMode()) document.body.classList.add('dark-mode'); },
        formatarData(data) { return new Date(data).toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); },
        calcularTempoAteProximaDose(horario) { const agora = new Date(); const [horas, minutos] = horario.split(':'); const proximaDose = new Date(); proximaDose.setHours(parseInt(horas), parseInt(minutos), 0, 0); if (proximaDose < agora) proximaDose.setDate(proximaDose.getDate() + 1); const diff = proximaDose - agora; const horasRestantes = Math.floor(diff / 3600000); const minutosRestantes = Math.floor((diff % 3600000) / 60000); if (horasRestantes === 0 && minutosRestantes <= 0) return 'agora'; else if (horasRestantes === 0) return `em ${minutosRestantes} min`; else if (horasRestantes < 24) return `em ${horasRestantes}h ${minutosRestantes}min`; else return `amanhã às ${horario}`; }
    };

    const AuthManager = {
        currentUser: null,
        init() {
            auth.onAuthStateChanged(user => {
                const loginContainer = document.getElementById('login-container');
                const appContent = document.getElementById('app-content');
                document.getElementById('login-text').classList.remove('hidden');
                document.getElementById('login-spinner').classList.add('hidden');
                if (user) { this.currentUser = user; loginContainer.style.display = 'none'; appContent.style.display = 'block'; this.renderAuthenticatedUI(user); App.init(); } 
                else { this.currentUser = null; loginContainer.style.display = 'block'; appContent.style.display = 'none'; }
            });
        },
        login() {
            document.getElementById('login-text').classList.add('hidden');
            document.getElementById('login-spinner').classList.remove('hidden');
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => UI.mostrarToast(`Erro no login: ${error.message}`, 'error'));
        },
        logout() { auth.signOut(); },
        getCurrentUserId() { return this.currentUser ? this.currentUser.uid : null; },
        renderAuthenticatedUI(user) {
            document.getElementById('auth-container').innerHTML = `<img src="${user.photoURL}" alt="Foto" class="w-10 h-10 rounded-full border-2 border-blue-500"><div class="text-left"><p class="text-sm text-gray-600">Logado como</p><p class="font-semibold">${user.displayName}</p></div><button id="btn-logout" class="btn-icon p-2 ml-4 bg-gray-200 rounded-full hover:bg-red-100" title="Sair"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>`;
            document.getElementById('btn-logout').addEventListener('click', this.logout);
        }
    };

    const DataManager = {
        _getBaseRef() { const userId = AuthManager.getCurrentUserId(); if (!userId) return null; return database.ref(`easy_lists/${userId}/smart_nurse_data`); },
        async getPatientProfiles() { try { const baseRef = this._getBaseRef(); if (!baseRef) return []; const snapshot = await baseRef.child('profiles').get(); return snapshot.val() || []; } catch (e) { console.error(e); return []; } },
        async savePatientProfiles(profiles) { try { const baseRef = this._getBaseRef(); if (!baseRef) return false; await baseRef.child('profiles').set(profiles); return true; } catch (e) { console.error(e); return false; } },
        _getPatientDataRef(patientId) { const baseRef = this._getBaseRef(); if (!baseRef || !patientId) return null; return baseRef.child(`patient_data/${patientId}`); },
        async _loadData(patientId, key) { try { const patientRef = this._getPatientDataRef(patientId); if (!patientRef) return null; const snapshot = await patientRef.child(key).get(); return snapshot.val(); } catch (e) { console.error(e); return null; } },
        async _saveData(patientId, key, data) { try { const patientRef = this._getPatientDataRef(patientId); if (!patientRef) return false; await patientRef.child(key).set(data); return true; } catch (e) { console.error(e); return false; } },
        async carregarTratamentos(patientId) { return await this._loadData(patientId, 'treatments') || []; },
        async salvarTratamentos(patientId, treatments) { return await this._saveData(patientId, 'treatments', treatments); },
        async carregarDoses(patientId) { return await this._loadData(patientId, 'doses') || []; },
        async salvarDoses(patientId, doses) { return await this._saveData(patientId, 'doses', doses); },
        async precisaGerarDosesHoje(patientId) { const hoje = new Date().toLocaleDateString('pt-BR'); const ultimaGeracao = await this._loadData(patientId, 'last_generation'); return ultimaGeracao !== hoje; },
        async marcarGeracaoHoje(patientId) { const hoje = new Date().toLocaleDateString('pt-BR'); await this._saveData(patientId, 'last_generation', hoje); },
        carregarDarkMode() { return localStorage.getItem('smartnurse_darkMode_v9') === 'true'; },
        salvarDarkMode(ativado) { localStorage.setItem('smartnurse_darkMode_v9', ativado.toString()); },
        async carregarNotificacoes(patientId) { return await this._loadData(patientId, 'notificationsEnabled') || false; },
        async salvarNotificacoes(patientId, ativado) { return await this._saveData(patientId, 'notificationsEnabled', ativado); },
        async carregarAntecedencia(patientId) { const val = await this._loadData(patientId, 'notificationLeadTime'); return val ?? 10; },
        async salvarAntecedencia(patientId, minutos) { return await this._saveData(patientId, 'notificationLeadTime', minutos); }
    };
    
    const UserManager = {
        async init() { await this.renderUserSelector(); await this.renderUserList(); },
        async addUser() { const nameInput = document.getElementById('new-user-name'); const name = nameInput.value.trim(); if (!name) return; let profiles = await DataManager.getPatientProfiles(); const newProfile = { id: Date.now().toString(), name }; profiles.push(newProfile); await DataManager.savePatientProfiles(profiles); await this.renderUserSelector(); await this.renderUserList(); document.getElementById('user-selector').value = newProfile.id; await App.setActivePatient(newProfile.id); UI.mostrarToast(`Paciente "${name}" adicionado.`, 'success'); nameInput.value = ''; },
        async deleteUser(userId) { if (!confirm('Tem certeza que deseja excluir este paciente e todos os seus dados? Esta ação é irreversível.')) return; let profiles = await DataManager.getPatientProfiles(); const userToDelete = profiles.find(p => p.id === userId); profiles = profiles.filter(p => p.id !== userId); await DataManager.savePatientProfiles(profiles); await this.renderUserSelector(); await this.renderUserList(); if (App.activePatientId === userId) await App.setActivePatient(''); UI.mostrarToast(`Paciente "${userToDelete.name}" excluído.`, 'info'); },
        async renderUserSelector() { const selector = document.getElementById('user-selector'); const profiles = await DataManager.getPatientProfiles(); const activeId = localStorage.getItem(`activePatient_${AuthManager.getCurrentUserId()}`); selector.innerHTML = '<option value="">-- Selecione um Paciente --</option>'; profiles.forEach(p => { const option = document.createElement('option'); option.value = p.id; option.textContent = p.name; if (p.id === activeId) option.selected = true; selector.appendChild(option); }); },
        async renderUserList() { const container = document.getElementById('user-list-container'); const profiles = await DataManager.getPatientProfiles(); container.innerHTML = ''; if (profiles.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">Nenhum paciente cadastrado.</p>'; return; } profiles.forEach(p => { const div = document.createElement('div'); div.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg'; div.innerHTML = `<span class="font-medium">${p.name}</span><button class="btn-delete-user p-2 text-red-500 hover:bg-red-100 rounded-full transition-colors" data-id="${p.id}" title="Excluir Paciente"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`; container.appendChild(div); }); }
    };
    
    const TreatmentManager = {
        tratamentos: [], dosesDiarias: [],
        async init() { this.tratamentos = await DataManager.carregarTratamentos(App.activePatientId); if (await DataManager.precisaGerarDosesHoje(App.activePatientId)) { await this.gerarDosesParaHoje(); await DataManager.marcarGeracaoHoje(App.activePatientId); } else { this.dosesDiarias = await DataManager.carregarDoses(App.activePatientId); } },
        clear() { this.tratamentos = []; this.dosesDiarias = []; },
        async gerarDosesParaHoje() { const hoje = new Date(); hoje.setHours(0, 0, 0, 0); this.dosesDiarias = []; this.tratamentos.forEach(trat => { const dataInicio = new Date(trat.dataInicio); dataInicio.setHours(0, 0, 0, 0); const diffDays = Math.ceil((hoje - dataInicio) / 86400000); const dentroDoTratamento = trat.tipotratamento === 'continuo' || (diffDays >= 0 && diffDays < trat.duracao); if (dentroDoTratamento) { trat.horarios.forEach(horario => this.dosesDiarias.push({ id: `${trat.id}-${horario}`, tratamentoId: trat.id, nome: trat.nome, dosagem: trat.dosagem, horario: horario, instrucoes: trat.instrucoes, diaAtual: trat.tipotratamento === 'continuo' ? '∞' : diffDays + 1, duracaoTotal: trat.tipotratamento === 'continuo' ? '∞' : trat.duracao, concluido: false })); } }); await DataManager.salvarDoses(App.activePatientId, this.dosesDiarias); },
        async handleFormSubmit() { if (!FormManager.validarFormulario()) { UI.mostrarToast('Por favor, preencha todos os campos obrigatórios.', 'error'); return; } const id = document.getElementById('tratamento-id').value; const dados = FormManager.coletarDados(); let sucesso; if (id) { sucesso = await this.editarTratamento(id, dados); } else { sucesso = await this.adicionarTratamento(dados); } if (sucesso) { Renderer.renderDosesDiarias(); document.getElementById('med-modal').classList.add('hidden'); } },
        async adicionarTratamento(dados) { const novoTratamento = { ...dados, id: Date.now().toString(), dataInicio: new Date().toISOString() }; this.tratamentos.push(novoTratamento); if (await DataManager.salvarTratamentos(App.activePatientId, this.tratamentos)) { await this.gerarDosesParaHoje(); await DataManager.marcarGeracaoHoje(App.activePatientId); UI.mostrarToast('Tratamento adicionado com sucesso!', 'success'); return true; } return false; },
        async editarTratamento(id, dados) { const index = this.tratamentos.findIndex(t => t.id === id); if (index === -1) return false; this.tratamentos[index] = { ...this.tratamentos[index], ...dados }; if (await DataManager.salvarTratamentos(App.activePatientId, this.tratamentos)) { await this.gerarDosesParaHoje(); await DataManager.marcarGeracaoHoje(App.activePatientId); UI.mostrarToast('Tratamento atualizado com sucesso!', 'success'); return true; } return false; },
        async excluirTratamento(id) { this.tratamentos = this.tratamentos.filter(t => t.id !== id); if (await DataManager.salvarTratamentos(App.activePatientId, this.tratamentos)) { await this.gerarDosesParaHoje(); await DataManager.marcarGeracaoHoje(App.activePatientId); UI.mostrarToast('Tratamento excluído com sucesso!', 'success'); window.idParaExcluir = null; Renderer.renderRelatorio(); Renderer.renderDosesDiarias(); } },
        async toggleDose(id) { const dose = this.dosesDiarias.find(d => d.id === id); if (!dose) return; dose.concluido = !dose.concluido; await DataManager.salvarDoses(App.activePatientId, this.dosesDiarias); if (dose.concluido) { UI.mostrarToast(`✓ ${dose.nome} marcado como tomado!`, 'success'); } Renderer.renderDosesDiarias(); if (this.todasDosesConcluidas()) document.getElementById('modal-conclusao').classList.remove('hidden'); },
        todasDosesConcluidas() { return this.dosesDiarias.length > 0 && this.dosesDiarias.every(d => d.concluido); },
        obterProximaDose() { const agora = new Date(); const dosesNaoConcluidas = this.dosesDiarias.filter(d => !d.concluido).sort((a, b) => a.horario.localeCompare(b.horario)); if (dosesNaoConcluidas.length === 0) return null; for (const dose of dosesNaoConcluidas) { const [horas, minutos] = dose.horario.split(':'); const horarioDose = new Date(); horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0); if (horarioDose >= agora) return dose; } return dosesNaoConcluidas[0]; },
        obterEstatisticas() { const hoje = new Date(); hoje.setHours(0, 0, 0, 0); let ativos = 0, concluidos = 0; this.tratamentos.forEach(trat => { const dataInicio = new Date(trat.dataInicio); dataInicio.setHours(0, 0, 0, 0); const diffDays = Math.ceil((hoje - dataInicio) / 86400000); if (trat.tipotratamento === 'continuo') ativos++; else if (diffDays >= 0 && diffDays < trat.duracao) ativos++; else if (diffDays >= trat.duracao) concluidos++; }); return { total: this.tratamentos.length, ativos, concluidos }; }
    };
    
    const Renderer = {
        renderApp() {
            const mainControls = document.getElementById('main-controls');
            const footerProgress = document.getElementById('footer-progress');
            const placeholder = document.getElementById('placeholder');
            if (App.activePatientId) { mainControls.style.display = 'flex'; footerProgress.style.display = 'block'; this.renderDosesDiarias(); } 
            else { document.getElementById('checklist-container').innerHTML = ''; mainControls.style.display = 'none'; footerProgress.style.display = 'none'; placeholder.style.display = 'block'; document.getElementById('placeholder-icon').textContent = '👥'; document.getElementById('placeholder-title').textContent = 'Selecione ou crie um perfil de paciente para começar.'; document.getElementById('placeholder-subtitle').textContent = 'Use o menu "Paciente" acima para gerenciar os perfis.'; this.atualizarProgresso(); this.atualizarProximaDose(); NotificationManager.atualizarBadge(); }
        },
        renderDosesDiarias() { const container = document.getElementById('checklist-container'); const placeholder = document.getElementById('placeholder'); container.innerHTML = ''; if (TreatmentManager.dosesDiarias.length === 0) { placeholder.style.display = 'block'; container.style.display = 'none'; document.getElementById('placeholder-icon').textContent = '💊'; document.getElementById('placeholder-title').textContent = 'Nenhum tratamento ativo para hoje.'; document.getElementById('placeholder-subtitle').textContent = 'Clique no botão "Adicionar Tratamento" acima para começar!'; } else { placeholder.style.display = 'none'; container.style.display = 'block'; const groupedMeds = { 'Manhã ☀️': [], 'Tarde 🌇': [], 'Noite 🌙': [] }; TreatmentManager.dosesDiarias.sort((a, b) => a.horario.localeCompare(b.horario)); TreatmentManager.dosesDiarias.forEach(dose => { const hour = parseInt(dose.horario.split(':')[0], 10); if (hour >= 4 && hour < 12) groupedMeds['Manhã ☀️'].push(dose); else if (hour >= 12 && hour < 18) groupedMeds['Tarde 🌇'].push(dose); else groupedMeds['Noite 🌙'].push(dose); }); for (const periodo in groupedMeds) { if (groupedMeds[periodo].length > 0) { const section = document.createElement('section'); section.className = 'fade-in-scale'; section.innerHTML = `<h2 class="text-3xl font-bold text-white pb-2 mb-4 drop-shadow-lg">${periodo}</h2>`; groupedMeds[periodo].forEach(dose => section.appendChild(this.createMedCard(dose))); container.appendChild(section); } } } this.atualizarProgresso(); this.atualizarProximaDose(); NotificationManager.atualizarBadge(); },
        createMedCard(dose) { const card = document.createElement('div'); const agora = new Date(); const [horas, minutos] = dose.horario.split(':'); const horarioDose = new Date(); horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0); let cardClass = 'bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg border-l-8 border-gray-300 transition-all duration-300 cursor-pointer p-5 flex items-center gap-5 fade-in-scale hover:shadow-xl hover:scale-[1.02]'; if (dose.concluido) cardClass += ' card-concluido'; else if (horarioDose < agora) cardClass += ' card-atrasado'; else if (horarioDose - agora < 1800000) cardClass += ' card-proximo'; card.className = cardClass; card.dataset.id = dose.id; const diaInfo = dose.duracaoTotal === '∞' ? '(Contínuo)' : `(Dia ${dose.diaAtual}/${dose.duracaoTotal})`; card.innerHTML = `<div class="text-5xl flex-shrink-0">${dose.concluido ? '✅' : '⬜️'}</div><div class="flex-grow info-remedio"><h3 class="font-bold text-2xl">${dose.nome} <span class="text-lg font-medium text-gray-500">${diaInfo}</span></h3><p class="text-gray-600 text-lg mt-1">💊 ${dose.dosagem}</p><p class="text-gray-600 text-lg">⏰ ${dose.horario}</p><p class="text-gray-600 text-lg">🍽️ ${dose.instrucoes}</p></div>`; return card; },
        atualizarProgresso() { const total = TreatmentManager.dosesDiarias.length; const concluidos = TreatmentManager.dosesDiarias.filter(d => d.concluido).length; const percent = total > 0 ? Math.round((concluidos / total) * 100) : 0; const progressBar = document.getElementById('progress-bar'); const progressText = document.getElementById('progress-text'); progressBar.style.width = `${percent}%`; progressBar.textContent = total > 0 ? `${percent}%` : ''; progressText.textContent = total > 0 ? `Você tomou ${concluidos} de ${total} medicamentos hoje.` : 'Nenhum medicamento para hoje.'; },
        atualizarProximaDose() { const proximaDose = TreatmentManager.obterProximaDose(); const container = document.getElementById('next-dose-info'); const text = document.getElementById('next-dose-text'); if (proximaDose) { const tempo = UI.calcularTempoAteProximaDose(proximaDose.horario); text.textContent = `${proximaDose.nome} às ${proximaDose.horario} (${tempo})`; container.classList.remove('hidden'); } else { container.classList.add('hidden'); } },
        renderRelatorio() { const conteudo = document.getElementById('relatorio-conteudo'); document.getElementById('relatorio-data').textContent = new Date().toLocaleDateString('pt-BR'); conteudo.innerHTML = ''; if (TreatmentManager.tratamentos.length === 0) { conteudo.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum tratamento cadastrado para este paciente.</p>'; document.getElementById('stats-total').textContent = 0; document.getElementById('stats-ativos').textContent = 0; document.getElementById('stats-concluidos').textContent = 0; return; } const stats = TreatmentManager.obterEstatisticas(); document.getElementById('stats-total').textContent = stats.total; document.getElementById('stats-ativos').textContent = stats.ativos; document.getElementById('stats-concluidos').textContent = stats.concluidos; const hoje = new Date(); hoje.setHours(0, 0, 0, 0); TreatmentManager.tratamentos.forEach(trat => { const dataInicio = new Date(trat.dataInicio); dataInicio.setHours(0, 0, 0, 0); const diasPassados = Math.max(0, Math.ceil((hoje - dataInicio) / 86400000)); let diaAtual, progresso, statusBadge; if (trat.tipotratamento === 'continuo') { progresso = 100; statusBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">Contínuo</span>'; } else { diaAtual = Math.min(diasPassados + 1, trat.duracao); progresso = Math.min(100, Math.round((diaAtual / trat.duracao) * 100)); if (diaAtual >= trat.duracao) statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">Concluído</span>'; else statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-semibold">Em andamento</span>'; } const itemRelatorio = document.createElement('div'); itemRelatorio.className = 'p-5 border-2 border-gray-200 rounded-xl relative hover:border-blue-300 transition bg-gradient-to-r from-white to-gray-50'; itemRelatorio.innerHTML = `<div class="absolute top-3 right-3 flex gap-2 no-print"><button class="btn-edit btn-icon p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" data-id="${trat.id}" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button class="btn-delete btn-icon p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition" data-id="${trat.id}" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div><div class="pr-20"><div class="flex items-center gap-3 mb-2"><h3 class="font-bold text-xl">${trat.nome}</h3>${statusBadge}</div><p class="text-gray-600 mb-1"><span class="font-semibold">Dose:</span> ${trat.dosagem}</p><p class="text-gray-600 mb-1"><span class="font-semibold">Horários:</span> ${trat.horarios.join(', ')}</p><p class="text-gray-600 mb-1"><span class="font-semibold">Instruções:</span> ${trat.instrucoes}</p><p class="text-sm text-gray-500 mt-2">Início: ${dataInicio.toLocaleDateString('pt-BR')}</p></div><div class="mt-4"><div class="flex justify-between items-center mb-2"><span class="text-base font-semibold text-blue-700">${trat.tipotratamento === 'continuo' ? 'Tratamento Contínuo' : `Dia ${diaAtual} de ${trat.duracao}`}</span><span class="font-bold text-lg">${progresso}%</span></div><div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"><div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${progresso}%"></div></div></div>`; conteudo.appendChild(itemRelatorio); }); }
    };
    
    const FormManager = {
        limparFormulario() { document.getElementById('form-remedio').reset(); document.getElementById('tratamento-id').value = ''; document.getElementById('modal-title').textContent = 'Novo Tratamento'; document.getElementById('horarios-container').innerHTML = ''; document.getElementById('instrucoes-personalizadas-container').classList.add('hidden'); document.getElementById('duracao-container').style.display = 'block'; UI.limparErros(); this.adicionarCampoHorario(); },
        adicionarCampoHorario(horario = '') { const container = document.getElementById('horarios-container'); const div = document.createElement('div'); div.className = 'flex items-center gap-2'; div.innerHTML = `<input type="time" value="${horario}" required class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><button type="button" class="btn-remove-horario text-red-500 hover:text-red-700 hover:bg-red-50 font-bold text-2xl px-3 py-2 rounded-lg transition">×</button>`; container.appendChild(div); div.querySelector('.btn-remove-horario').addEventListener('click', () => { if (container.children.length > 1) div.remove(); else UI.mostrarToast('É necessário pelo menos um horário', 'error'); }); },
        preencherHorariosSugestao(intervalo) { const container = document.getElementById('horarios-container'); container.innerHTML = ''; const numDoses = 24 / intervalo; for (let i = 0; i < numDoses; i++) { const hora = (8 + (i * intervalo)) % 24; this.adicionarCampoHorario(`${hora.toString().padStart(2, '0')}:00`); } UI.mostrarToast(`Horários sugeridos adicionados (a cada ${intervalo}h)`, 'info'); },
        validarFormulario() { let valido = true; if (!UI.validarCampo(document.getElementById('nome-remedio'), 'Informe o nome do remédio')) valido = false; if (!UI.validarCampo(document.getElementById('dosagem-remedio'), 'Informe a dosagem')) valido = false; if (document.getElementById('tipo-tratamento').value === 'temporario') { const duracao = document.getElementById('duracao-tratamento'); if (!duracao.value || parseInt(duracao.value) < 1) { duracao.classList.add('input-error'); document.getElementById('error-duracao-tratamento').textContent = 'Informe a duração'; document.getElementById('error-duracao-tratamento').classList.remove('hidden'); valido = false; } } const horarios = Array.from(document.querySelectorAll('#horarios-container input[type="time"]')).filter(input => input.value); if (horarios.length === 0) { document.getElementById('error-horarios').textContent = 'Adicione pelo menos um horário'; document.getElementById('error-horarios').classList.remove('hidden'); valido = false; } else { document.getElementById('error-horarios').classList.add('hidden'); } return valido; },
        coletarDados() { const tipoTratamento = document.getElementById('tipo-tratamento').value; let instrucoes = document.getElementById('instrucoes-remedio').value; if (instrucoes === 'personalizado') instrucoes = document.getElementById('instrucoes-personalizadas').value.trim() || 'Conforme orientação médica'; const horarios = Array.from(document.querySelectorAll('#horarios-container input[type="time"]')).map(i => i.value).filter(Boolean).sort(); return { nome: document.getElementById('nome-remedio').value.trim(), dosagem: document.getElementById('dosagem-remedio').value.trim(), tipotratamento: tipoTratamento, duracao: tipoTratamento === 'temporario' ? parseInt(document.getElementById('duracao-tratamento').value) : null, horarios, instrucoes }; },
        preencherFormulario(id) { const trat = TreatmentManager.tratamentos.find(t => t.id === id); if (!trat) return; document.getElementById('tratamento-id').value = trat.id; document.getElementById('modal-title').textContent = 'Editar Tratamento'; document.getElementById('nome-remedio').value = trat.nome; document.getElementById('dosagem-remedio').value = trat.dosagem; document.getElementById('tipo-tratamento').value = trat.tipotratamento || 'temporario'; if (trat.tipotratamento === 'continuo') { document.getElementById('duracao-container').style.display = 'none'; } else { document.getElementById('duracao-tratamento').value = trat.duracao; document.getElementById('duracao-container').style.display = 'block'; } const opcoes = Array.from(document.querySelectorAll('#instrucoes-remedio option')).map(opt => opt.value); if (opcoes.includes(trat.instrucoes)) { document.getElementById('instrucoes-remedio').value = trat.instrucoes; document.getElementById('instrucoes-personalizadas-container').classList.add('hidden'); } else { document.getElementById('instrucoes-remedio').value = 'personalizado'; document.getElementById('instrucoes-personalizadas').value = trat.instrucoes; document.getElementById('instrucoes-personalizadas-container').classList.remove('hidden'); } document.getElementById('horarios-container').innerHTML = ''; trat.horarios.forEach(h => this.adicionarCampoHorario(h)); }
    };
    
    const NotificationManager = {
        intervaloVerificacao: null,
        async solicitarPermissao() { if (!('Notification' in window)) { UI.mostrarToast('Seu navegador não suporta notificações', 'error'); return false; } if (Notification.permission === 'granted') return true; if (Notification.permission === 'denied') return false; const permission = await Notification.requestPermission(); return permission === 'granted'; },
        enviarNotificacao(titulo, corpo) { if (Notification.permission !== 'granted') return; try { const notification = new Notification(titulo, { body: corpo, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">💊</text></svg>', badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">💊</text></svg>', tag: 'medicamento-lembrete', requireInteraction: true, vibrate: [200, 100, 200] }); notification.onclick = () => { window.focus(); notification.close(); }; } catch (e) { console.error(e); } },
        async iniciarVerificacao() { if (this.intervaloVerificacao) clearInterval(this.intervaloVerificacao); this.intervaloVerificacao = setInterval(() => this.verificarHorarios(), 60000); await this.verificarHorarios(); },
        async verificarHorarios() { if (!(await DataManager.carregarNotificacoes(App.activePatientId)) || Notification.permission !== 'granted') return; const doses = await DataManager.carregarDoses(App.activePatientId); if (!doses) return; const agora = new Date(); const antecedencia = await DataManager.carregarAntecedencia(App.activePatientId); doses.forEach(dose => { if (dose.concluido) return; const [horas, minutos] = dose.horario.split(':'); const horarioDose = new Date(); horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0); const horarioNotificacao = new Date(horarioDose.getTime() - antecedencia * 60000); if (agora.getHours() === horarioNotificacao.getHours() && agora.getMinutes() === horarioNotificacao.getMinutes()) this.enviarNotificacao(`⏰ Hora do remédio: ${dose.nome}`, `${dose.dosagem} às ${dose.horario}\n${dose.instrucoes}`); }); },
        pararVerificacao() { if (this.intervaloVerificacao) clearInterval(this.intervaloVerificacao); this.intervaloVerificacao = null; },
        async atualizarBadge() { const badge = document.getElementById('notification-badge'); if (!App.activePatientId) { badge.classList.add('hidden'); return; } const doses = TreatmentManager.dosesDiarias; const agora = new Date(); let pendentes = 0; doses.forEach(dose => { if (dose.concluido) return; const [horas, minutos] = dose.horario.split(':'); const horarioDose = new Date(); horarioDose.setHours(parseInt(horas), parseInt(minutos), 0, 0); if (horarioDose <= agora) pendentes++; }); if (pendentes > 0) { badge.textContent = pendentes; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } },
        updateStatusUI() { const statusEl = document.getElementById('notificacao-status'); const statusTextEl = statusEl.querySelector('p'); statusEl.className = 'p-4 rounded-lg text-center'; if (!('Notification' in window)) { statusEl.classList.add('bg-red-100', 'text-red-800'); statusTextEl.textContent = 'Seu navegador não suporta notificações.'; return; } const permission = Notification.permission; if (permission === 'granted') { statusEl.classList.add('bg-green-100', 'text-green-800'); statusTextEl.textContent = 'Status: Permitido. As notificações estão prontas.'; } else if (permission === 'denied') { statusEl.classList.add('bg-red-100', 'text-red-800'); statusTextEl.textContent = 'Status: Bloqueado. Altere as permissões do navegador.'; } else { statusEl.classList.add('bg-yellow-100', 'text-yellow-800'); statusTextEl.textContent = 'Status: Pendente. Ative a chave para solicitar.'; } },
        async handleOpenModal() { if (!App.activePatientId) { UI.mostrarToast('Selecione um paciente para configurar.', 'error'); return; } document.getElementById('modal-notificacoes').classList.remove('hidden'); NotificationManager.updateStatusUI(); const btnToggle = document.getElementById('btn-toggle-notificacoes'); const ativado = await DataManager.carregarNotificacoes(App.activePatientId); btnToggle.dataset.enabled = ativado.toString(); const span = btnToggle.querySelector('span'); if (ativado) { btnToggle.classList.remove('bg-gray-300'); btnToggle.classList.add('bg-blue-600'); span.style.transform = 'translateX(24px)'; } else { btnToggle.classList.add('bg-gray-300'); btnToggle.classList.remove('bg-blue-600'); span.style.transform = 'translateX(0)'; } document.getElementById('select-antecedencia').value = await DataManager.carregarAntecedencia(App.activePatientId); },
        async handleToggle(button) { const estavaAtivado = button.dataset.enabled === 'true'; if (!estavaAtivado) { const permitido = await this.solicitarPermissao(); this.updateStatusUI(); if (permitido) { button.dataset.enabled = 'true'; button.classList.remove('bg-gray-300'); button.classList.add('bg-blue-600'); button.querySelector('span').style.transform = 'translateX(24px)'; await DataManager.salvarNotificacoes(App.activePatientId, true); await this.iniciarVerificacao(); UI.mostrarToast('Notificações ativadas!', 'success'); } else { UI.mostrarToast('Permissão de notificações não concedida.', 'error'); } } else { button.dataset.enabled = 'false'; button.classList.remove('bg-blue-600'); button.classList.add('bg-gray-300'); button.querySelector('span').style.transform = 'translateX(0)'; await DataManager.salvarNotificacoes(App.activePatientId, false); this.pararVerificacao(); UI.mostrarToast('Notificações desativadas.', 'info'); } },
        async handleAntecedenciaChange(select) { await DataManager.salvarAntecedencia(App.activePatientId, parseInt(select.value)); UI.mostrarToast('Antecedência atualizada.', 'info'); },
        testarNotificacao() { if (Notification.permission === 'granted') this.enviarNotificacao('💊 Teste de Notificação', 'Se você está vendo isso, as notificações estão funcionando!'); else UI.mostrarToast('Notificações não permitidas. Verifique o status.', 'error'); }
    };
    
    const ExportManager = {
        async exportarCSV() { if (TreatmentManager.tratamentos.length === 0) { UI.mostrarToast('Nenhum tratamento para exportar', 'error'); return; } const profiles = await DataManager.getPatientProfiles(); const activePatient = profiles.find(p => p.id === App.activePatientId); const patientName = activePatient ? activePatient.name.replace(/\s/g, '_') : 'Paciente'; let csv = 'Nome,Dosagem,Tipo,Duração (dias),Horários,Instruções,Data de Início\n'; TreatmentManager.tratamentos.forEach(trat => { const tipo = trat.tipotratamento === 'continuo' ? 'Contínuo' : 'Temporário'; const duracao = trat.tipotratamento === 'continuo' ? 'N/A' : trat.duracao; const horarios = `"${trat.horarios.join('; ')}"`; const dataInicio = new Date(trat.dataInicio).toLocaleDateString('pt-BR'); csv += `"${trat.nome}","${trat.dosagem}","${tipo}","${duracao}",${horarios},"${trat.instrucoes}","${dataInicio}"\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `tratamentos_${patientName}_${new Date().toISOString().split('T')[0]}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); UI.mostrarToast('Relatório exportado com sucesso!', 'success'); }
    };

    const App = {
        activePatientId: null,
        listenersAdded: false,
        async init() {
            UI.aplicarDarkMode();
            document.getElementById('current-date').textContent = UI.formatarData(new Date());
            await UserManager.init();
            this.addEventListeners();
            const lastPatientId = localStorage.getItem(`activePatient_${AuthManager.getCurrentUserId()}`);
            if (lastPatientId) {
                const profiles = await DataManager.getPatientProfiles();
                if (profiles.some(p => p.id === lastPatientId)) {
                    document.getElementById('user-selector').value = lastPatientId;
                    await this.setActivePatient(lastPatientId);
                }
            } else {
                 await this.setActivePatient('');
            }
        },
        async setActivePatient(patientId) {
            this.activePatientId = patientId;
            if (patientId) {
                localStorage.setItem(`activePatient_${AuthManager.getCurrentUserId()}`, patientId);
                await TreatmentManager.init();
            } else {
                localStorage.removeItem(`activePatient_${AuthManager.getCurrentUserId()}`);
                TreatmentManager.clear();
            }
            Renderer.renderApp();
        },
        addEventListeners() {
            if (this.listenersAdded) return;
            document.getElementById('btn-login').addEventListener('click', AuthManager.login);
            document.getElementById('btn-toggle-dark').addEventListener('click', UI.toggleDarkMode);
            document.getElementById('user-selector').addEventListener('change', (e) => this.setActivePatient(e.target.value));
            document.getElementById('btn-manage-users').addEventListener('click', () => document.getElementById('user-modal').classList.remove('hidden'));
            document.getElementById('btn-close-user-modal').addEventListener('click', () => document.getElementById('user-modal').classList.add('hidden'));
            document.getElementById('btn-close-user-modal-x').addEventListener('click', () => document.getElementById('user-modal').classList.add('hidden'));
            document.getElementById('form-add-user').addEventListener('submit', async (e) => { e.preventDefault(); await UserManager.addUser(); });
            document.getElementById('user-list-container').addEventListener('click', async (e) => { const btn = e.target.closest('.btn-delete-user'); if (btn) await UserManager.deleteUser(btn.dataset.id); });
            document.getElementById('btn-open-modal').addEventListener('click', () => { FormManager.limparFormulario(); document.getElementById('med-modal').classList.remove('hidden'); });
            document.getElementById('btn-cancel-modal').addEventListener('click', () => document.getElementById('med-modal').classList.add('hidden'));
            document.getElementById('btn-close-modal-x').addEventListener('click', () => document.getElementById('med-modal').classList.add('hidden'));
            document.getElementById('form-remedio').addEventListener('submit', async (e) => { e.preventDefault(); await TreatmentManager.handleFormSubmit(); });
            document.getElementById('btn-add-horario').addEventListener('click', () => FormManager.adicionarCampoHorario());
            document.querySelectorAll('.btn-sugestao').forEach(btn => btn.addEventListener('click', () => FormManager.preencherHorariosSugestao(parseInt(btn.dataset.intervalo))));
            document.getElementById('tipo-tratamento').addEventListener('change', function() { document.getElementById('duracao-container').style.display = this.value === 'continuo' ? 'none' : 'block'; document.getElementById('duracao-tratamento').required = this.value !== 'continuo'; });
            document.getElementById('instrucoes-remedio').addEventListener('change', function() { document.getElementById('instrucoes-personalizadas-container').classList.toggle('hidden', this.value !== 'personalizado'); });
            document.getElementById('checklist-container').addEventListener('click', async (e) => { const card = e.target.closest('[data-id]'); if (card) await TreatmentManager.toggleDose(card.dataset.id); });
            document.getElementById('btn-reset').addEventListener('click', () => document.getElementById('modal-conclusao').classList.add('hidden'));
            document.getElementById('btn-open-relatorio').addEventListener('click', () => { Renderer.renderRelatorio(); document.getElementById('relatorio-modal').classList.remove('hidden'); });
            document.getElementById('btn-fechar-relatorio').addEventListener('click', () => document.getElementById('relatorio-modal').classList.add('hidden'));
            document.getElementById('btn-close-relatorio-x').addEventListener('click', () => document.getElementById('relatorio-modal').classList.add('hidden'));
            document.getElementById('btn-salvar-relatorio').addEventListener('click', () => window.print());
            document.getElementById('btn-exportar-csv').addEventListener('click', () => ExportManager.exportarCSV());
            document.getElementById('relatorio-conteudo').addEventListener('click', (e) => { const btnEdit = e.target.closest('.btn-edit'); const btnDelete = e.target.closest('.btn-delete'); if (btnEdit) { FormManager.preencherFormulario(btnEdit.dataset.id); document.getElementById('relatorio-modal').classList.add('hidden'); document.getElementById('med-modal').classList.remove('hidden'); } if (btnDelete) { window.idParaExcluir = btnDelete.dataset.id; document.getElementById('modal-confirmar-exclusao').classList.remove('hidden'); } });
            document.getElementById('btn-confirmar-exclusao').addEventListener('click', async () => { if (window.idParaExcluir) await TreatmentManager.excluirTratamento(window.idParaExcluir); document.getElementById('modal-confirmar-exclusao').classList.add('hidden'); });
            document.getElementById('btn-cancelar-exclusao').addEventListener('click', () => { window.idParaExcluir = null; document.getElementById('modal-confirmar-exclusao').classList.add('hidden'); });
            document.getElementById('btn-notifications').addEventListener('click', NotificationManager.handleOpenModal);
            document.getElementById('btn-close-notificacoes-x').addEventListener('click', () => document.getElementById('modal-notificacoes').classList.add('hidden'));
            document.getElementById('btn-fechar-notificacoes').addEventListener('click', () => document.getElementById('modal-notificacoes').classList.add('hidden'));
            document.getElementById('btn-toggle-notificacoes').addEventListener('click', async function() { await NotificationManager.handleToggle(this); });
            document.getElementById('select-antecedencia').addEventListener('change', async function() { await NotificationManager.handleAntecedenciaChange(this); });
            document.getElementById('btn-testar-notificacao').addEventListener('click', NotificationManager.testarNotificacao);
            setInterval(() => { if (App.activePatientId) { Renderer.atualizarProximaDose(); NotificationManager.atualizarBadge(); } }, 60000);
            this.listenersAdded = true;
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        AuthManager.init();
    });
</script>
</body>
</html>
