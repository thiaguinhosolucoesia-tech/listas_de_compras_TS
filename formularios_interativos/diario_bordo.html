<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Bordo Profissional</title>
    <meta name="theme-color" content="#0D47A1"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --primary-color: #1A237E; /* Azul corporativo escuro */
            --accent-color: #009688; /* Verde/Azul para a√ß√µes positivas */
            --light-bg: #F5F7FA; /* Fundo muito claro, quase branco */
            --text-color: #212121;
            --border-color: #DDE2E8;
            --background-color: #ECEFF1; /* Fundo geral cinza azulado */
            --white: #fff;
            --success-green: #4CAF50;
            --warning-amber: #FFC107;
            --gray: #757575;
            --info-purple: #673AB7;
            --header-bg: #E8EAF6; /* Fundo do cabe√ßalho levemente azulado */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; padding: 15px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--white); padding: 20px 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        header { text-align: center; margin-bottom: 25px; background-color: var(--header-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        header h1 { color: var(--primary-color); font-size: 2.2em; margin-bottom: 10px; }
        .date-navigation { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 5px; }
        .nav-btn { background: none; border: none; font-size: 2.2em; cursor: pointer; color: var(--primary-color); padding: 0 10px; transition: transform 0.2s; }
        .nav-btn:hover:not(:disabled) { transform: scale(1.1); }
        .nav-btn:disabled { color: var(--gray); opacity: 0.5; cursor: not-allowed; }
        #currentDate { font-size: 1.3em; color: var(--primary-color); font-weight: 600; }
        
        #actionBank { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--light-bg); }
        #actionBank summary { background-color: var(--primary-color); color: var(--white); padding: 12px 15px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: background-color 0.2s; }
        #actionBank summary:hover { background-color: #283593; }
        #actionBank[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .action-bank-content { max-height: 350px; overflow-y: auto; padding: 15px; background-color: var(--light-bg); border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        .action-bank-content h4 { color: var(--primary-color); margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-size: 1.1em; }
        .action-item { padding: 10px; margin: 4px 0; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.2s, transform 0.1s; background-color: var(--white); border: 1px solid var(--border-color); }
        .action-item:hover { background-color: var(--accent-color); color: var(--white); transform: translateX(5px); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        
        .daily-wrapper { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 900px) { .daily-wrapper { grid-template-columns: 1fr 1fr; } }
        .section-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; transition: all 0.3s ease; background-color: var(--white); }
        fieldset:disabled { opacity: 0.7; background-color: #F8F9FA; }
        .section-box h2 { font-size: 1.6em; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        #reviewBox h2 { color: var(--info-purple); }
        .form-section label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; background-color: var(--white); transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.2); outline: none; }
        textarea { min-height: 100px; resize: vertical; }
        #todo-list li { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background-color: #F8F8F8; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
        #todo-list li span { flex-grow: 1; }
        .button-container { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        button { background-color: var(--primary-color); color: var(--white); border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.05em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        button:disabled { background-color: var(--gray); cursor: not-allowed; transform: none; box-shadow: none; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button.save-btn, button#endDayBtn { background-color: var(--accent-color); }
        button.save-btn:hover:not(:disabled), button#endDayBtn:hover:not(:disabled) { background-color: #00796B; }

        #nextDayTips, .edit-log { display: none; margin-top: 25px; padding: 15px; background-color: #FFFBEB; border-left: 5px solid var(--warning-amber); border-radius: 0 8px 8px 0; font-size: 0.9em; }
        .edit-log { background-color: #E3F2FD; border-color: var(--primary-color); color: var(--primary-color); }
        #weeklySummarySection { display: none; margin-top: 30px; }
        #weeklySummaryContent { white-space: pre-wrap; font-family: "SF Mono", "Courier New", monospace; line-height: 1.8; background-color: #F5F5F5; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9em; overflow-x: auto; color: var(--text-color); }
        footer { text-align: center; margin-top: 40px; color: var(--gray); font-size: 0.9em; padding: 10px; background-color: var(--header-bg); border-radius: 8px; }
        .kpi-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; align-items: flex-end; margin-bottom: 10px; }
        .kpi-grid label { margin-bottom: 0; }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>Di√°rio de Bordo Profissional</h1>
            <div class="date-navigation">
                <button id="prevDayBtn" class="nav-btn">&lt;</button>
                <p id="currentDate"></p>
                <button id="nextDayBtn" class="nav-btn">&gt;</button>
            </div>
        </header>

        <div id="settingsBox" class="section-box" style="margin-bottom: 20px;">
            <div class="form-section">
                <label for="userName">Seu Identificador (Nome ou ID - Sens√≠vel a mai√∫sculas/min√∫sculas)</label>
                <input type="text" id="userName" placeholder="Usado para salvar e carregar seus dados na nuvem.">
            </div>
        </div>

        <details id="actionBank" open>
            <summary>üí° Banco de A√ß√µes Estrat√©gicas (Clique para expandir)</summary>
            <div class="action-bank-content" id="action-bank-content">
                <h4>üéØ Estrat√©gia & Metas</h4>
                <div class="action-item">Revisar os OKRs/metas do trimestre e conectar com uma tarefa de hoje.</div>
                <div class="action-item">Dedicar 30 min de 'deep work' na tarefa mais importante do projeto X.</div>
                <div class="action-item">Analisar um relat√≥rio de performance e extrair um insight acion√°vel.</div>
                <div class="action-item">Fazer um brainstorming de 15 min para resolver um obst√°culo espec√≠fico.</div>
                <div class="action-item">Mapear os pr√≥ximos passos de um projeto estrat√©gico.</div>

                <h4>üìà Comercial & Marketing</h4>
                <div class="action-item">Fazer follow-up com 3 leads/clientes estrat√©gicos.</div>
                <div class="action-item">Planejar um post/conte√∫do para redes sociais ou blog da empresa.</div>
                <div class="action-item">Analisar a performance da √∫ltima campanha de marketing.</div>
                <div class="action-item">Pedir um depoimento ou feedback de um cliente satisfeito.</div>
                <div class="action-item">Pesquisar um concorrente e identificar uma oportunidade.</div>

                <h4>üë• Lideran√ßa & Equipe</h4>
                <div class="action-item">Dar um feedback construtivo e espec√≠fico para um membro da equipe.</div>
                <div class="action-item">Reconhecer publicamente (em reuni√£o ou chat) uma boa entrega da equipe.</div>
                <div class="action-item">Fazer um 'check-in' individual de 10 min com um liderado.</div>
                <div class="action-item">Delegar uma tarefa com clareza, explicando o 'porqu√™'.</div>
                <div class="action-item">Revisar e otimizar a distribui√ß√£o de tarefas da equipe para a semana.</div>

                <h4>ü§ù Comunica√ß√£o & Stakeholders</h4>
                <div class="action-item">Enviar um e-mail de alinhamento para as partes interessadas de um projeto.</div>
                <div class="action-item">Agendar uma conversa dif√≠cil que est√° sendo adiada.</div>
                <div class="action-item">Preparar a pauta para a pr√≥xima reuni√£o importante.</div>
                <div class="action-item">Agradecer um colega de outro departamento pela ajuda.</div>
                <div class="action-item">Fazer um follow-up com um stakeholder 'apenas para manter o relacionamento'.</div>

                <h4>‚öôÔ∏è Processos & Opera√ß√µes</h4>
                <div class="action-item">Mapear e identificar um gargalo em um processo recorrente.</div>
                <div class="action-item">Dedicar 15 minutos para organizar sua √°rea de trabalho (f√≠sica ou digital).</div>
                <div class="action-item">Automatizar ou criar um template para uma tarefa repetitiva.</div>
                <div class="action-item">Revisar o fluxo de caixa ou o or√ßamento de um projeto.</div>
                <div class="action-item">Implementar um checklist para um processo cr√≠tico para garantir a qualidade.</div>
            </div>
        </details>

        <div class="daily-wrapper">
            <div id="planningBox" class="section-box">
                <h2>Planejamento do Dia</h2>
                <form id="planningForm">
                    <fieldset id="planningFieldset">
                        <div class="form-section"><label for="dailyFocus">Foco Principal do Dia</label><input type="text" id="dailyFocus" placeholder="Ex: Avan√ßar 20% no relat√≥rio de vendas trimestral."></div>
                        <div class="form-section"><label for="criticalTasks">Prioridades (Exigem sua atua√ß√£o direta)</label><textarea id="criticalTasks" rows="3" placeholder="Ex: Alinhar escopo do projeto Y com o Diretor."></textarea></div>
                        <div class="form-section"><label>A Realizar (To-Do)</label>
                            <ul id="todo-list" style="list-style-type: none; padding-left: 0;"></ul>
                            <div style="display:flex; gap: 5px; margin-top: 10px;"><input type="text" id="new-todo-input" placeholder="Nova tarefa..."><button type="button" id="add-todo-btn" style="padding: 0 15px;">+</button></div>
                        </div>
                        <div style="display: grid; gap: 20px; grid-template-columns: 1fr 1fr;">
                           <div><label for="doing">Em Andamento</label><textarea id="doing" placeholder="Ex: Analisando dados..."></textarea></div>
                           <div><label for="delegated">Delegado</label><textarea id="delegated" placeholder="Ex: Relat√≥rio inicial para [Nome]..."></textarea></div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div id="reviewBox" class="section-box">
                <h2>Revis√£o e Fechamento do Dia</h2>
                <form id="reviewForm">
                     <fieldset id="reviewFieldset">
                        <div class="form-section"><label for="mainAchievement">Principal Conquista</label><input type="text" id="mainAchievement" placeholder="Qual foi o maior avan√ßo de hoje?"></div>
                        <div class="form-section"><label for="mainChallenge">Principal Desafio/Aprendizado</label><input type="text" id="mainChallenge" placeholder="O que te bloqueou ou o que voc√™ aprendeu?"></div>
                        <div class="form-section"><label for="uncompletedTasks">O que n√£o foi conclu√≠do e por qu√™?</label><textarea id="uncompletedTasks" rows="2" placeholder="Ex: Faltou informa√ß√£o do setor X."></textarea></div>
                        <div class="form-section"><label>M√©tricas do Dia</label>
                            <div class="kpi-grid">
                                <label for="kpi1Name">Nome do KPI 1</label><label for="kpi1Value">Valor</label>
                                <input type="text" id="kpi1Name" placeholder="Ex: Vendas"><input type="number" id="kpi1Value" value="0">
                            </div>
                            <div class="kpi-grid">
                                <label for="kpi2Name">Nome do KPI 2</label><label for="kpi2Value">Valor</label>
                                <input type="text" id="kpi2Name" placeholder="Ex: Leads Gerados"><input type="number" id="kpi2Value" value="0">
                            </div>
                             <div style="margin-top: 15px;">
                                 <label for="energyLevel">N√≠vel de Energia (1-5)</label>
                                 <input type="number" id="energyLevel" min="1" max="5" style="width: 100px;">
                            </div>
                        </div>
                    </fieldset>
                </form>
                <div class="button-container">
                    <button type="button" id="editDayBtn">Editar Dia</button>
                    <button type="button" id="endDayBtn">Analisar e Finalizar Dia</button>
                </div>
                <div id="nextDayTips"><h3>üí° Assistente de Performance para Amanh√£</h3><p id="tipContent"></p></div>
                <div class="edit-log" id="editLog"></div>
            </div>
        </div>
        <div class="button-container" style="margin-top: 40px;"><button type="button" id="showWeeklySummaryBtn">Gerar Painel de Controle da Semana</button></div>
        <section id="weeklySummarySection"><h2 style="text-align:center; color: var(--primary-color); margin-bottom: 20px;">Painel de Controle da Semana</h2><pre id="weeklySummaryContent"></pre></section>
    </main>
    <footer><p>Desenvolvido com ü§ñ por thIAguinho Solu√ß√µes</p></footer>

    <script>
        // --- IN√çCIO DA CONFIGURA√á√ÉO FIREBASE ---
        // SUBSTITUA ESTES VALORES PELOS DO SEU PROJETO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAo9iVQm_BzmvNLAUxc4pGL_qp6ic4JQfo",
            authDomain: "listas-de-compras-ff4a3.firebaseapp.com",
            databaseURL: "https://listas-de-compras-ff4a3-default-rtdb.firebaseio.com",
            projectId: "listas-de-compras-ff4a3",
            storageBucket: "listas-de-compras-ff4a3.firebasestorage.app",
            messagingSenderId: "623752672529",
            appId: "1:623752672529:web:ba43bfdad31f050da3c8b0"
        };
        // --- FIM DA CONFIGURA√á√ÉO FIREBASE ---

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                data: {},
                userName: '',
                displayedDate: new Date(),
                today: new Date(),
                isEditing: false,

                init() {
                    this.today.setHours(0, 0, 0, 0);
                    this.displayedDate.setHours(0, 0, 0, 0);
                    this.loadUserName();
                    this.addEventListeners();
                    // Renderiza o dia apenas depois de carregar o nome de usu√°rio
                    if (this.userName) {
                        this.loadDayData(this.getDateString(this.displayedDate));
                    } else {
                        this.renderDay(this.getDateString(this.displayedDate));
                    }
                },

                getDateString: date => date.toISOString().split('T')[0],

                loadUserName() {
                    this.userName = localStorage.getItem('professionalLogUserName') || '';
                    document.getElementById('userName').value = this.userName;
                },

                saveUserName() {
                    const newUserName = document.getElementById('userName').value.trim();
                    if (newUserName !== this.userName) {
                        this.userName = newUserName;
                        localStorage.setItem('professionalLogUserName', this.userName);
                        // Recarrega os dados para o novo usu√°rio
                        this.loadDayData(this.getDateString(this.displayedDate));
                    }
                },
                
                async loadDayData(dateString) {
                    if (!this.userName) {
                        console.log("Nome de usu√°rio n√£o definido. Abortando carregamento de dados.");
                        this.data[dateString] = null; // Limpa dados se o usu√°rio for apagado
                        this.renderDay(dateString);
                        return;
                    }
                    const dataRef = database.ref(`diario-de-bordo/${this.userName}/${dateString}`);
                    try {
                        const snapshot = await dataRef.once('value');
                        this.data[dateString] = snapshot.val();
                        this.renderDay(dateString);
                    } catch (error) {
                        console.error("Erro ao carregar dados do Firebase:", error);
                        alert("N√£o foi poss√≠vel carregar os dados. Verifique a conex√£o e a configura√ß√£o do Firebase.");
                    }
                },

                renderDay(dateString) {
                    document.getElementById('currentDate').textContent = this.displayedDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    document.getElementById('nextDayBtn').disabled = this.getDateString(this.displayedDate) === this.getDateString(this.today);
                    document.getElementById('planningForm').reset();
                    document.getElementById('reviewForm').reset();
                    document.getElementById('todo-list').innerHTML = '';
                    document.getElementById('nextDayTips').style.display = 'none';
                    document.getElementById('editLog').style.display = 'none';

                    const dayData = this.data[dateString];
                    this.isEditing = false;
                    
                    if (!dayData || !dayData.review) {
                        this.isEditing = true;
                        document.getElementById('editDayBtn').style.display = 'none';
                        document.getElementById('endDayBtn').style.display = 'block';
                        document.getElementById('endDayBtn').textContent = 'Analisar e Finalizar Dia';
                    } else {
                        document.getElementById('editDayBtn').style.display = 'block';
                        document.getElementById('editDayBtn').textContent = 'Editar Dia';
                        document.getElementById('endDayBtn').style.display = 'none';
                    }
                    
                    this.toggleFieldsDisabled(!this.isEditing);
                    if (!dayData) return;

                    const plan = dayData.plan || {};
                    document.getElementById('dailyFocus').value = plan.dailyFocus || '';
                    document.getElementById('criticalTasks').value = plan.criticalTasks || '';
                    document.getElementById('doing').value = plan.doing || '';
                    document.getElementById('delegated').value = plan.delegated || '';
                    
                    (plan.todo || []).forEach(task => this.createTodoElement(task));
                    
                    if (dayData.review) {
                        const review = dayData.review || {};
                        Object.keys(review).forEach(key => { const el = document.getElementById(key); if (el) el.value = review[key]; });
                        this.generateTips(dayData);
                    }

                    if (dayData.log && dayData.log.length > 0) {
                        const lastEdit = dayData.log[dayData.log.length - 1];
                        const editDate = new Date(lastEdit.timestamp).toLocaleString('pt-BR');
                        document.getElementById('editLog').textContent = `√öltima edi√ß√£o em ${editDate}.`;
                        document.getElementById('editLog').style.display = 'block';
                    }
                },

                toggleFieldsDisabled(isDisabled) {
                    document.getElementById('planningFieldset').disabled = isDisabled;
                    document.getElementById('reviewFieldset').disabled = isDisabled;
                },

                async toggleEditMode() {
                    const dateString = this.getDateString(this.displayedDate);
                    const dayData = this.data[dateString];
                    if (!dayData || !dayData.review) return;

                    this.isEditing = !this.isEditing;
                    this.toggleFieldsDisabled(!this.isEditing);

                    const editBtn = document.getElementById('editDayBtn');
                    if (this.isEditing) {
                        editBtn.textContent = 'Salvar Altera√ß√µes';
                        editBtn.classList.add('save-btn');
                    } else {
                        editBtn.textContent = 'Editar Dia';
                        editBtn.classList.remove('save-btn');
                        await this.saveCurrentState(true); // torna ass√≠ncrono
                        this.loadDayData(dateString); // Recarrega do firebase para garantir consist√™ncia
                    }
                },
                
                addEventListeners() {
                    document.getElementById('userName').addEventListener('change', () => this.saveUserName());
                    document.getElementById('endDayBtn').addEventListener('click', () => this.endDay());
                    document.getElementById('editDayBtn').addEventListener('click', () => this.toggleEditMode());
                    document.getElementById('showWeeklySummaryBtn').addEventListener('click', () => this.showWeeklySummary());
                    document.getElementById('prevDayBtn').addEventListener('click', () => this.navigateDays(-1));
                    document.getElementById('nextDayBtn').addEventListener('click', () => this.navigateDays(1));
                    document.getElementById('add-todo-btn').addEventListener('click', () => this.addTodoItem());
                    document.getElementById('new-todo-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.addTodoItem(); }});
                    document.getElementById('action-bank-content').addEventListener('click', (e) => {
                        if (e.target.classList.contains('action-item')) {
                            this.addTodoItem(e.target.textContent);
                        }
                    });
                },

                navigateDays(direction) {
                    this.displayedDate.setDate(this.displayedDate.getDate() + direction);
                    this.loadDayData(this.getDateString(this.displayedDate));
                },

                addTodoItem(predefinedText = null) {
                    const input = document.getElementById('new-todo-input');
                    const text = predefinedText || input.value.trim();
                    if (text) {
                        this.createTodoElement({ text, deferred: false });
                        input.value = '';
                    }
                },
                
                createTodoElement(task) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${task.text}</span> <label style="font-weight:normal; font-size: 0.9em;"><input type="checkbox" class="defer-checkbox" ${task.deferred ? 'checked' : ''}> Adiar</label>`;
                    document.getElementById('todo-list').appendChild(li);
                },
                
                async saveCurrentState(isEdit = false) {
                     const dateString = this.getDateString(this.displayedDate);
                     if (!this.userName) {
                         alert("Por favor, preencha seu Identificador para salvar seus registros na nuvem.");
                         document.getElementById('userName').focus();
                         return false;
                     }

                     const todoItems = Array.from(document.querySelectorAll('#todo-list li')).map(li => ({
                        text: li.querySelector('span').textContent,
                        deferred: li.querySelector('.defer-checkbox').checked
                    }));

                    const plan = { dailyFocus: document.getElementById('dailyFocus').value.trim(), criticalTasks: document.getElementById('criticalTasks').value.trim(), todo: todoItems, doing: document.getElementById('doing').value.trim(), delegated: document.getElementById('delegated').value.trim() };
                    const review = { mainAchievement: document.getElementById('mainAchievement').value.trim(), mainChallenge: document.getElementById('mainChallenge').value.trim(), uncompletedTasks: document.getElementById('uncompletedTasks').value.trim(), energyLevel: document.getElementById('energyLevel').value, kpi1Name: document.getElementById('kpi1Name').value.trim(), kpi1Value: document.getElementById('kpi1Value').value, kpi2Name: document.getElementById('kpi2Name').value.trim(), kpi2Value: document.getElementById('kpi2Value').value };
                    
                    let dayData = this.data[dateString] || { log: [] };
                    dayData.plan = plan;
                    if(review.mainAchievement || review.energyLevel > 0) { dayData.review = review; }
                    
                    if (isEdit) {
                        if(!dayData.log) dayData.log = [];
                        dayData.log.push({ timestamp: new Date().toISOString() });
                    }
                    
                    try {
                        const dataRef = database.ref(`diario-de-bordo/${this.userName}/${dateString}`);
                        await dataRef.set(dayData);
                        console.log('Estado salvo no Firebase √†s', new Date().toLocaleTimeString());
                        this.data[dateString] = dayData; // Atualiza o estado local
                        return true;
                    } catch (error) {
                        console.error("Erro ao salvar no Firebase:", error);
                        alert("N√£o foi poss√≠vel salvar os dados. Verifique sua conex√£o.");
                        return false;
                    }
                },

                async endDay() {
                    if (!document.getElementById('mainAchievement').value || !document.getElementById('energyLevel').value) {
                        alert('Por favor, preencha a Conquista do Dia e seu N√≠vel de Energia para finalizar.'); return;
                    }
                    if (!(await this.saveCurrentState(true))) return;

                    if (confirm('Tem certeza que deseja finalizar e analisar o dia? Tarefas adiadas ser√£o movidas para amanh√£.')) {
                        const dateString = this.getDateString(this.displayedDate);
                        const dayData = this.data[dateString];
                        const deferredTasks = dayData.plan.todo.filter(t => t.deferred);
                        
                        if (deferredTasks.length > 0) {
                            const nextDay = new Date(this.displayedDate); nextDay.setDate(nextDay.getDate() + 1);
                            const nextDayString = this.getDateString(nextDay);
                            
                            // Busca os dados do dia seguinte antes de sobrescrever
                            const nextDayRef = database.ref(`diario-de-bordo/${this.userName}/${nextDayString}`);
                            const snapshot = await nextDayRef.once('value');
                            const nextDayData = snapshot.val() || { plan: { todo: [] }, log: [] };

                            if (!nextDayData.plan.todo) nextDayData.plan.todo = [];
                            const newTasks = deferredTasks.map(task => ({ text: `[ADIADO] ${task.text}`, deferred: false }));
                            nextDayData.plan.todo = [...newTasks, ...nextDayData.plan.todo];
                            
                            await nextDayRef.set(nextDayData); // Salva o dia seguinte atualizado
                        }
                        
                        this.loadDayData(dateString); // Recarrega o dia atual para mostrar o estado finalizado
                        alert('Dia finalizado e analisado! Insights gerados e tarefas adiadas.');
                    }
                },
                
                async showWeeklySummary() {
                    if (!this.userName) {
                        alert("Por favor, preencha seu Identificador para gerar o relat√≥rio.");
                        return;
                    }

                    const summarySection = document.getElementById('weeklySummarySection');
                    summarySection.style.display = 'block';
                    
                    const today = new Date(this.displayedDate); today.setHours(0, 0, 0, 0);
                    const dayOfWeek = today.getDay();
                    const offsetToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    const firstDayOfWeek = new Date(today); firstDayOfWeek.setDate(today.getDate() + offsetToMonday);
                    const lastDayOfWeek = new Date(firstDayOfWeek); lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                    let summaryText = `PAINEL DE CONTROLE SEMANAL\nSemana de ${firstDayOfWeek.toLocaleDateString('pt-BR')} a ${lastDayOfWeek.toLocaleDateString('pt-BR')}\n================================================\n\n`;
                    let daysData = [];
                    let promises = [];

                    for (let i = 0; i < 7; i++) {
                        const date = new Date(firstDayOfWeek); date.setDate(date.getDate() + i);
                        const dateString = this.getDateString(date);
                        const dataRef = database.ref(`diario-de-bordo/${this.userName}/${dateString}`);
                        promises.push(dataRef.once('value').then(snapshot => ({ date, data: snapshot.val() })));
                    }

                    const results = await Promise.all(promises);

                    for (const result of results) {
                        if (result.data && result.data.review && result.data.review.energyLevel) {
                            daysData.push(result);
                            const dayLabel = result.date.toLocaleDateString('pt-BR', {weekday: 'long', day: '2-digit', month: '2-digit'});
                            summaryText += `--- ${dayLabel.toUpperCase()} ---\n`;
                            summaryText += `  Foco: ${result.data.plan.dailyFocus || 'N√£o definido'}\n`;
                            summaryText += `  Conquista: ${result.data.review.mainAchievement || 'N√£o registrada'}\n`;
                            summaryText += `  Desafio: ${result.data.review.mainChallenge || 'N√£o registrado'}\n\n`;
                        }
                    }

                    if(daysData.length === 0) {
                        summaryText += "Nenhum dia foi finalizado e analisado nesta semana. Preencha seus dias para um resumo poderoso!";
                    } else {
                        summaryText += this.generateProfessionalAnalysis(daysData);
                    }
                    
                    document.getElementById('weeklySummaryContent').textContent = summaryText;
                    summarySection.scrollIntoView({ behavior: 'smooth' });
                },

                generateProfessionalAnalysis(daysData) {
                    let analysis = "--- AN√ÅLISE DE PERFORMANCE DA SEMANA ---\n";
                    const totalDays = daysData.length;
                    const avgEnergy = daysData.reduce((sum, d) => sum + (parseInt(d.data.review.energyLevel, 10) || 0), 0) / totalDays;

                    analysis += `  Diagn√≥stico Geral:\n`;
                    analysis += `    - N√≠vel m√©dio de energia: ${avgEnergy.toFixed(1)}/5.0\n\n`;

                    // An√°lise de KPIs
                    const kpis = {};
                    daysData.forEach(d => {
                        const r = d.data.review;
                        if (r.kpi1Name && r.kpi1Value) {
                            if (!kpis[r.kpi1Name]) kpis[r.kpi1Name] = 0;
                            kpis[r.kpi1Name] += parseFloat(r.kpi1Value) || 0;
                        }
                        if (r.kpi2Name && r.kpi2Value) {
                            if (!kpis[r.kpi2Name]) kpis[r.kpi2Name] = 0;
                            kpis[r.kpi2Name] += parseFloat(r.kpi2Value) || 0;
                        }
                    });
                    
                    if (Object.keys(kpis).length > 0) {
                        analysis += `  Totalizadores de KPIs da Semana:\n`;
                        for (const key in kpis) {
                            analysis += `    - ${key}: ${kpis[key]}\n`;
                        }
                        analysis += `\n`;
                    }
                    
                    analysis += `  Recomenda√ß√µes Estrat√©gicas:\n`;

                    if (avgEnergy < 2.5) {
                        analysis += `    - GEST√ÉO DE ENERGIA: Seu n√≠vel de energia esteve consistentemente baixo. Isso √© um risco para a sustentabilidade da performance. Para a pr√≥xima semana, identifique UMA tarefa operacional que possa ser delegada ou automatizada. Proteger sua energia √© uma atividade estrat√©gica.\n`;
                    } else if (avgEnergy >= 4.0) {
                        analysis += `    - ENERGIA EM ALTA: Seu n√≠vel de energia foi elevado! Como voc√™ pode replicar as condi√ß√µes (tipo de tarefa, ambiente, colabora√ß√µes) que levaram a isso? Compartilhe essa energia com a equipe para impulsionar a produtividade geral.\n`;
                    } else {
                        analysis += `    - ENERGIA EST√ÅVEL: Seu n√≠vel de energia est√° equilibrado. Mantenha as boas pr√°ticas de gest√£o de tempo e prioriza√ß√£o. Identifique se algum desafio recorrente pode ser mitigado para elevar ainda mais sua performance.\n`;
                    }
                    
                    return analysis;
                },
                
                generateTips(dayData) {
                    let tips = [];
                    const { plan, review } = dayData;
                    if (plan.dailyFocus && review.mainAchievement && !review.mainAchievement.toLowerCase().includes(plan.dailyFocus.toLowerCase().slice(0, 10))) {
                        tips.push("INSIGHT DE FOCO: Sua principal conquista pareceu diferente do foco que voc√™ definiu. Isso pode indicar que urg√™ncias desviaram sua energia. Avalie se o foco de amanh√£ precisa ser mais protegido e se o planejamento foi realista.");
                    }
                    if (review.uncompletedTasks) {
                        tips.push(`PEND√äNCIAS: Voc√™ mencionou tarefas n√£o conclu√≠das: "${review.uncompletedTasks}". Avalie se alguma delas deve ser a **primeira prioridade** de amanh√£ para evitar o efeito "bola de neve" ou se podem ser delegadas.`);
                    }
                    if (review.energyLevel <= 2) {
                        tips.push(`ENERGIA: Seu n√≠vel de energia foi baixo hoje. A consist√™ncia vence a intensidade. Garanta uma pausa revigorante de 10 minutos amanh√£, longe das telas. Sua performance sustent√°vel √© o maior ativo.`);
                    } else if (review.energyLevel >= 4) {
                        tips.push(`ALAVANCAGEM DA ENERGIA: Seu n√≠vel de energia esteve alto! Qual foi o fator principal? Pense em como replicar essa condi√ß√£o e como usar essa energia positiva para motivar a equipe amanh√£. Celebre as pequenas vit√≥rias!`);
                    }
                    if (review.mainAchievement) {
                        tips.push(`IMPACTO: Sua principal conquista foi "${review.mainAchievement}". Como voc√™ pode comunicar este sucesso (para sua lideran√ßa, equipe, stakeholders) para gerar um impacto ainda maior amanh√£?`);
                    }
                    const tipsContainer = document.getElementById('nextDayTips');
                    document.getElementById('tipContent').textContent = tips.length > 0 ? tips.join('\n\n') : 'Dia produtivo! Mantenha o foco e a consist√™ncia. √ìtimo trabalho!';
                    tipsContainer.style.display = 'block';
                },
            };

            App.init();
            
        });
    </script>
</body>
</html>
